<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tower Manufacturing Management System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS for Excel Processing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <!-- jsPDF for PDF Reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #1e40af;
            --secondary-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        @media (max-width: 768px) {
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            .mobile-hidden {
                display: none !important;
            }
            
            .mobile-full-width {
                width: 100% !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            
            .mobile-stack {
                display: block !important;
            }
            
            .mobile-stack > * {
                margin-bottom: 1rem;
                width: 100% !important;
            }
            
            .mobile-text-center {
                text-align: center !important;
            }
            
            .mobile-padding {
                padding: 1rem !important;
            }
            
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .card {
                margin: 0.5rem !important;
                padding: 1rem !important;
            }
            
            .modal-content {
                width: 95% !important;
                margin: 1rem !important;
            }
            
            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 0.75rem !important;
            }
            
            .action-buttons {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            .action-buttons button {
                width: 100% !important;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .tablet-grid-2 {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            .tablet-full-width {
                width: 100% !important;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .card-header {
            border-bottom: 2px solid #f3f4f6;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-body {
            padding: 1.25rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            gap: 0.5rem;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #1e3a8a;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #0d9664;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #d1d5db;
            color: #374151;
        }

        .btn-outline:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: 0.875rem 1.75rem;
            font-size: 1rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-label {
            display: block;
            margin-bottom: 0.375rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }

        .input-field {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: white;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-field.error {
            border-color: var(--danger-color);
        }

        .error-message {
            color: var(--danger-color);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: block;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-primary {
            background: #dbeafe;
            color: var(--primary-color);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-body {
            padding: 1.25rem;
        }

        .modal-footer {
            padding: 1.25rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .toast-container {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-width: 400px;
            width: 90%;
        }

        .toast {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
            transform: translateX(-120%);
            transition: transform 0.3s ease-out;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            background: var(--secondary-color);
        }

        .toast-error {
            background: var(--danger-color);
        }

        .toast-warning {
            background: var(--warning-color);
        }

        .toast-info {
            background: var(--info-color);
        }

        .toast-close {
            margin-right: auto;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            opacity: 0.8;
            padding: 0.25rem;
        }

        .toast-close:hover {
            opacity: 1;
        }

        .progress {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            background-color: #1e40af; /* Added background color for tabs */
        }

        .tab {
            padding: 0.875rem 1.25rem;
            font-weight: 600;
            color: #ffffff; /* Changed to white for better visibility */
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab:hover {
            color: #fbbf24; /* Changed to yellow on hover for better visibility */
            background: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            color: #ffffff; /* Changed to white for active tab */
            border-bottom-color: #fbbf24; /* Changed to yellow for active tab */
            background: rgba(255, 255, 255, 0.1);
        }

        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            position: relative;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .table th {
            background: #f9fafb;
            padding: 0.875rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            color: #4b5563;
        }

        .table tr:hover {
            background: #f9fafb;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }

        @media (max-width: 768px) {
            .grid-cols-2,
            .grid-cols-3,
            .grid-cols-4 {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .tabs {
                background-color: #1e40af; /* Ensure background color on mobile */
            }
            
            .tab {
                color: #ffffff; /* Ensure white text on mobile */
            }
            
            .tab.active {
                color: #ffffff; /* Ensure white text for active tab on mobile */
                border-bottom-color: #fbbf24; /* Ensure yellow border for active tab on mobile */
            }
        }

        .backup-card {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }

        .backup-card:hover {
            border-color: var(--primary-color);
            background: #f0f9ff;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            
            #reportResults,
            #reportResults * {
                visibility: visible;
            }
            
            #reportResults {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
            }
            
            .no-print,
            .action-buttons {
                display: none !important;
            }
            
            .table {
                font-size: 10pt !important;
            }
            
            .table th,
            .table td {
                padding: 0.5rem !important;
            }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        @media (prefers-color-scheme: dark) {
            .card {
                background: #1f2937;
                border-color: #374151;
                color: #f9fafb;
            }
            
            .table th {
                background: #111827;
                color: #f9fafb;
                border-color: #374151;
            }
            
            .table td {
                color: #d1d5db;
                border-color: #374151;
            }
            
            .input-field {
                background: #374151;
                border-color: #4b5563;
                color: #f9fafb;
            }
            
            .input-field:focus {
                border-color: var(--primary-color);
            }
            
            .tabs {
                background-color: #1e40af; /* Keep blue background in dark mode */
            }
            
            .tab {
                color: #ffffff; /* Keep white text in dark mode */
            }
            
            .tab.active {
                color: #ffffff; /* Keep white text for active tab in dark mode */
                border-bottom-color: #fbbf24; /* Keep yellow border for active tab in dark mode */
            }
        }

        /* Scroll to top button */
        .scroll-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .scroll-to-top:hover {
            background: #1e3a8a;
            transform: translateY(-2px);
        }

        /* Searchable dropdown */
        .searchable-select {
            position: relative;
        }

        .searchable-select input {
            width: 100%;
        }

        .searchable-select .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .searchable-select .dropdown-list.active {
            display: block;
        }

        .searchable-select .dropdown-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .searchable-select .dropdown-item:hover {
            background: #f3f4f6;
        }

        .searchable-select .dropdown-item.selected {
            background: var(--primary-color);
            color: white;
        }

        /* Status indicators */
        .current-phase {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            background: #dbeafe;
            color: #1e40af;
            margin-top: 0.25rem;
        }

        .completed-first {
            background: #f0fdf4 !important;
        }
    </style>
</head>
<body class="text-gray-800">
    <!-- Header -->
    <header class="bg-blue-900 text-white shadow-lg no-print">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3 mobile-text-center">
                <i class="fa-solid fa-tower-cell text-3xl text-yellow-400"></i>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold">Tower Manufacturing Management System</h1>
                    <p class="text-xs md:text-sm text-blue-200">66KV - 220KV - 500KV - Telecom</p>
                </div>
            </div>
            <div class="flex flex-wrap gap-2 justify-center">
                <button onclick="showOperatorsManagement()" class="btn btn-warning btn-sm">
                    <i class="fa-solid fa-users-gear"></i> Manage Operators
                </button>
                <button onclick="showBackupModal()" class="btn btn-secondary btn-sm">
                    <i class="fa-solid fa-download ml-1"></i> Backup
                </button>
                <button onclick="clearDatabase()" class="btn btn-danger btn-sm">
                    <i class="fa-solid fa-trash-can ml-1"></i> Clear Database
                </button>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="container mx-auto px-4">
            <div class="tabs">
                <button onclick="switchTab('dashboard')" class="tab">
                    <i class="fa-solid fa-gauge-high"></i>
                    <span class="mobile-hidden">Dashboard</span>
                </button>
                <button onclick="switchTab('models')" class="tab active">
                    <i class="fa-solid fa-database"></i>
                    <span class="mobile-hidden">Database</span>
                </button>
                <button onclick="switchTab('workOrder')" class="tab">
                    <i class="fa-solid fa-file-circle-plus"></i>
                    <span class="mobile-hidden">Work Orders</span>
                </button>
                <button onclick="switchTab('production')" class="tab">
                    <i class="fa-solid fa-industry"></i>
                    <span class="mobile-hidden">Daily Production</span>
                </button>
                <button onclick="switchTab('reports')" class="tab">
                    <i class="fa-solid fa-chart-column"></i>
                    <span class="mobile-hidden">Reports</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Dashboard Section -->
        <section id="dashboardSection" class="space-y-6 hidden">
            <div class="card">
                <div class="card-header">
                    <h2 class="text-xl font-bold">
                        <i class="fa-solid fa-gauge-high mr-2 text-blue-600"></i>Production Dashboard
                    </h2>
                    <button onclick="refreshDashboard()" class="btn btn-outline btn-sm">
                        <i class="fa-solid fa-rotate"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="card bg-gradient-to-r from-blue-50 to-blue-100 border-blue-200">
                            <div class="p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="block text-2xl font-bold text-blue-600" id="dashboardActiveWorkOrders">0</span>
                                        <span class="text-sm text-gray-600">Active Work Orders</span>
                                    </div>
                                    <i class="fa-solid fa-file-contract text-2xl text-blue-400"></i>
                                </div>
                                <div class="progress mt-3">
                                    <div class="progress-bar" id="workOrdersProgress"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card bg-gradient-to-r from-green-50 to-green-100 border-green-200">
                            <div class="p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="block text-2xl font-bold text-green-600" id="dashboardTotalItems">0</span>
                                        <span class="text-sm text-gray-600">Items in Production</span>
                                    </div>
                                    <i class="fa-solid fa-industry text-2xl text-green-400"></i>
                                </div>
                                <div class="progress mt-3">
                                    <div class="progress-bar bg-green-500" id="itemsProgress"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card bg-gradient-to-r from-purple-50 to-purple-100 border-purple-200">
                            <div class="p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="block text-2xl font-bold text-purple-600" id="dashboardCompletedToday">0</span>
                                        <span class="text-sm text-gray-600">Completed Today</span>
                                    </div>
                                    <i class="fa-solid fa-calendar-check text-2xl text-purple-400"></i>
                                </div>
                                <div class="progress mt-3">
                                    <div class="progress-bar bg-purple-500" id="todayProgress"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card bg-gradient-to-r from-orange-50 to-orange-100 border-orange-200">
                            <div class="p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="block text-2xl font-bold text-orange-600" id="dashboardPendingOperations">0</span>
                                        <span class="text-sm text-gray-600">Pending Operations</span>
                                    </div>
                                    <i class="fa-solid fa-clock text-2xl text-orange-400"></i>
                                </div>
                                <div class="progress mt-3">
                                    <div class="progress-bar bg-orange-500" id="pendingProgress"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Active Work Orders -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="text-lg font-bold">
                                <i class="fa-solid fa-list-check mr-2 text-blue-600"></i>Active Work Orders Progress
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="workOrdersProgressContainer" class="space-y-4">
                                <p class="text-center text-gray-500 py-8">No active work orders</p>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Production -->
                    <div class="card mt-6">
                        <div class="card-header">
                            <h3 class="text-lg font-bold">
                                <i class="fa-solid fa-chart-line mr-2 text-green-600"></i>Recent Production
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="recentProductionContainer" class="space-y-3">
                                <p class="text-center text-gray-500 py-8">No recent production records</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Models Section (Default) -->
        <section id="modelsSection" class="space-y-6">
            <!-- Models Upload Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="text-xl font-bold">
                        <i class="fa-solid fa-database mr-2 text-blue-600"></i>Models Database
                    </h2>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Upload Form -->
                        <div class="lg:col-span-2">
                            <form id="uploadForm" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="input-group">
                                        <label class="input-label">Tower Type</label>
                                        <select id="towerType" class="input-field" required>
                                            <option value="" disabled selected>Select type...</option>
                                            <option value="66KV">66KV</option>
                                            <option value="220KV">220KV</option>
                                            <option value="500KV">500KV</option>
                                            <option value="Telecom">Telecom</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <label class="input-label">Model Name</label>
                                        <input type="text" id="modelName" placeholder="Example: T220-A1" class="input-field" required>
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <label class="input-label">Upload Excel File</label>
                                    <div class="backup-card p-6 rounded-lg text-center cursor-pointer" onclick="document.getElementById('fileInput').click()">
                                        <i class="fa-solid fa-cloud-arrow-up text-4xl text-blue-400 mb-3"></i>
                                        <p class="text-sm font-medium text-gray-700 mb-1">Click to upload or drag & drop</p>
                                        <p class="text-xs text-gray-500">File must contain required columns</p>
                                        <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden" onchange="handleFileSelect(event)">
                                    </div>
                                    <div id="fileName" class="text-sm text-green-600 mt-2 hidden"></div>
                                </div>
                                
                                <button type="button" onclick="processData()" class="btn btn-primary w-full">
                                    <i class="fa-solid fa-upload"></i> Process & Save Data
                                </button>
                            </form>
                        </div>
                        
                        <!-- Info Card -->
                        <div class="space-y-4">
                            <div class="card bg-blue-50 border-blue-200">
                                <div class="card-body">
                                    <h3 class="font-bold text-blue-800 mb-2">
                                        <i class="fa-solid fa-circle-info mr-2"></i> Important Information
                                    </h3>
                                    <ul class="text-sm text-blue-700 space-y-2 list-disc pl-4">
                                        <li>Excel file must contain these columns</li>
                                        <li>Item Name, Section, Steel Grade</li>
                                        <li>Operations (5 to 7 operations)</li>
                                        <li>Operations processed automatically</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-body">
                                    <h3 class="font-bold text-gray-700 mb-2">
                                        <i class="fa-solid fa-chart-bar mr-2"></i> Statistics
                                    </h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="text-center">
                                            <span id="totalModels" class="block text-2xl font-bold text-blue-600">0</span>
                                            <span class="text-xs text-gray-500">Models</span>
                                        </div>
                                        <div class="text-center">
                                            <span id="totalItems" class="block text-2xl font-bold text-purple-600">0</span>
                                            <span class="text-xs text-gray-500">Items</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Models List -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-lg font-bold">
                        <i class="fa-solid fa-list mr-2 text-blue-600"></i> Saved Models
                    </h3>
                    <div class="relative">
                        <input type="text" id="searchInput" onkeyup="renderModelsList()" placeholder="Search model..." class="input-field w-64">
                        <i class="fa-solid fa-search absolute right-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                <div class="card-body">
                    <div id="modelsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <p class="text-center text-gray-500 col-span-2 py-10">No saved models. Upload your first Excel file.</p>
                    </div>
                </div>
            </div>

            <!-- Model Details View -->
            <div id="detailsView" class="card hidden fade-in">
                <div class="card-header">
                    <div>
                        <h3 class="text-xl font-bold">
                            <i class="fa-solid fa-circle-info mr-2 text-blue-600"></i>
                            Model Details: <span id="viewTitle"></span>
                        </h3>
                        <span id="viewType" class="text-sm text-gray-500"></span>
                    </div>
                    <div class="action-buttons">
                        <button onclick="exportModelToPDF()" class="btn btn-danger btn-sm">
                            <i class="fa-solid fa-file-pdf"></i> Export PDF
                        </button>
                        <button onclick="hideDetails()" class="btn btn-outline btn-sm">
                            <i class="fa-solid fa-times"></i> Close
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Item Name</th>
                                    <th>Section</th>
                                    <th>Steel Grade</th>
                                    <th>Operation Sequence</th>
                                </tr>
                            </thead>
                            <tbody id="detailsTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Work Order Section -->
        <section id="workOrderSection" class="space-y-6 hidden">
            <!-- Work Order Upload -->
            <div class="card">
                <div class="card-header">
                    <h2 class="text-xl font-bold">
                        <i class="fa-solid fa-file-circle-plus mr-2 text-green-600"></i> Create New Work Order
                    </h2>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Form -->
                        <div class="lg:col-span-2">
                            <form id="workOrderForm" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="input-group">
                                        <label class="input-label">Work Order Name</label>
                                        <input type="text" id="workOrderName" placeholder="Example: WO-2024-001" class="input-field" required>
                                    </div>
                                    <div class="input-group">
                                        <label class="input-label">Project Name</label>
                                        <input type="text" id="projectName" placeholder="Example: Northern Network Project" class="input-field" required>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="input-group">
                                        <label class="input-label">Sales Order Number</label>
                                        <input type="text" id="salesOrderNumber" placeholder="Example: SO-2024-1001" class="input-field" required>
                                    </div>
                                    <div class="input-group">
                                        <label class="input-label">Tower Type</label>
                                        <select id="workOrderTowerType" class="input-field" onchange="populateModelDropdown()" required>
                                            <option value="" disabled selected>Select type...</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="input-group">
                                        <label class="input-label">Model</label>
                                        <select id="workOrderModel" class="input-field" required>
                                            <option value="" disabled selected>Select model...</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <label class="input-label">Upload Work Order File</label>
                                        <div class="backup-card p-4 rounded-lg text-center cursor-pointer" onclick="document.getElementById('workOrderFile').click()">
                                            <i class="fa-solid fa-cloud-arrow-up text-3xl text-green-400 mb-2"></i>
                                            <p class="text-sm font-medium text-gray-700">Click to upload or drag & drop</p>
                                            <input type="file" id="workOrderFile" accept=".xlsx,.xls" class="hidden" onchange="handleWorkOrderFileSelect(event)">
                                        </div>
                                        <div id="workOrderFileName" class="text-sm text-green-600 mt-2 hidden"></div>
                                    </div>
                                </div>
                                
                                <button type="button" onclick="processWorkOrder()" class="btn btn-secondary w-full">
                                    <i class="fa-solid fa-plus-circle"></i> Create Work Order
                                </button>
                            </form>
                        </div>
                        
                        <!-- Info -->
                        <div class="space-y-4">
                            <div class="card bg-green-50 border-green-200">
                                <div class="card-body">
                                    <h3 class="font-bold text-green-800 mb-2">
                                        <i class="fa-solid fa-lightbulb mr-2"></i> Notes
                                    </h3>
                                    <ul class="text-sm text-green-700 space-y-2 list-disc pl-4">
                                        <li>Select existing model from database</li>
                                        <li>Operations will be imported from selected model</li>
                                        <li>Work order file must contain quantities & weights</li>
                                        <li>Production status updated automatically</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-body">
                                    <h3 class="font-bold text-gray-700 mb-2">
                                        <i class="fa-solid fa-chart-pie mr-2"></i> Work Orders Statistics
                                    </h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="text-center">
                                            <span id="totalWorkOrders" class="block text-2xl font-bold text-green-600">0</span>
                                            <span class="text-xs text-gray-500">Work Orders</span>
                                        </div>
                                        <div class="text-center">
                                            <span id="workOrderItems" class="block text-2xl font-bold text-orange-600">0</span>
                                            <span class="text-xs text-gray-500">Items</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Work Orders List -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-lg font-bold">
                        <i class="fa-solid fa-file-lines mr-2 text-green-600"></i> Work Orders
                    </h3>
                    <div class="relative">
                        <input type="text" id="workOrderSearch" onkeyup="renderWorkOrdersList()" placeholder="Search work orders..." class="input-field w-64">
                        <i class="fa-solid fa-search absolute right-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                <div class="card-body">
                    <div id="workOrdersContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <p class="text-center text-gray-500 col-span-2 py-10">No work orders. Create your first work order.</p>
                    </div>
                </div>
            </div>

            <!-- Work Order Details -->
            <div id="workOrderDetailsView" class="card hidden fade-in">
                <div class="card-header">
                    <div>
                        <h3 class="text-xl font-bold">
                            <i class="fa-solid fa-file-contract mr-2 text-green-600"></i>
                            Work Order Details: <span id="workOrderTitle"></span>
                        </h3>
                        <div class="flex gap-2 mt-2">
                            <span id="workOrderType" class="badge badge-info"></span>
                            <span id="workOrderDate" class="text-sm text-gray-500"></span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="exportWorkOrderToExcel()" class="btn btn-secondary btn-sm">
                            <i class="fa-solid fa-file-excel"></i> Excel
                        </button>
                        <button onclick="exportWorkOrderToPDF()" class="btn btn-danger btn-sm">
                            <i class="fa-solid fa-file-pdf"></i> PDF
                        </button>
                        <button onclick="generateWorkOrderStatusReport()" class="btn btn-warning btn-sm">
                            <i class="fa-solid fa-chart-bar"></i> Report
                        </button>
                        <button onclick="hideWorkOrderDetails()" class="btn btn-outline btn-sm">
                            <i class="fa-solid fa-times"></i> Close
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Work Order Info -->
                    <div class="card bg-gray-50 mb-6">
                        <div class="card-body">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                    <span class="text-sm text-gray-500">Project:</span>
                                    <span id="workOrderProject" class="font-bold block"></span>
                                </div>
                                <div>
                                    <span class="text-sm text-gray-500">Sales Order:</span>
                                    <span id="workOrderSalesNumber" class="font-bold block"></span>
                                </div>
                                <div>
                                    <span class="text-sm text-gray-500">Creation Date:</span>
                                    <span id="workOrderCreationDate" class="font-bold block"></span>
                                </div>
                                <div>
                                    <span class="text-sm text-gray-500">Total Items:</span>
                                    <span id="workOrderTotalItems" class="font-bold block"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Item Name</th>
                                    <th>Section</th>
                                    <th>Steel Grade</th>
                                    <th>Length</th>
                                    <th>Quantity</th>
                                    <th>Weight/Piece</th>
                                    <th>Total Weight</th>
                                    <th>Operations</th>
                                </tr>
                            </thead>
                            <tbody id="workOrderDetailsTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Production Section -->
        <section id="productionSection" class="hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Production Input -->
                <section class="lg:col-span-4 space-y-6">
                    <!-- Production Card -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-xl font-bold">
                                <i class="fa-solid fa-industry mr-2 text-purple-600"></i> Daily Production
                            </h2>
                            <div class="flex gap-2">
                                <button onclick="saveProductionPreferences()" class="btn btn-secondary btn-sm">
                                    <i class="fa-solid fa-bookmark"></i> Save
                                </button>
                                <button onclick="clearProductionForm()" class="btn btn-outline btn-sm">
                                    <i class="fa-solid fa-eraser"></i> Clear
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="card bg-blue-50 border-blue-200 mb-4">
                                <div class="card-body p-3">
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid fa-info-circle text-blue-600"></i>
                                        <p class="text-sm text-blue-800">Your selections will be saved automatically for easier entry of subsequent items</p>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="productionForm" class="space-y-4">
                                <div class="input-group">
                                    <label class="input-label">Tower Type</label>
                                    <select id="productionTowerType" class="input-field" onchange="onTowerTypeChange()">
                                        <option value="" disabled selected>Select type...</option>
                                    </select>
                                </div>

                                <div class="input-group">
                                    <label class="input-label">Model</label>
                                    <select id="productionModel" class="input-field" onchange="onModelChange()">
                                        <option value="" disabled selected>Select model...</option>
                                    </select>
                                </div>

                                <div class="input-group">
                                    <label class="input-label">Work Order Number</label>
                                    <select id="productionWorkOrder" class="input-field" onchange="onWorkOrderChange()">
                                        <option value="" disabled selected>Select work order...</option>
                                    </select>
                                </div>

                                <div class="input-group">
                                    <label class="input-label">Project Name</label>
                                    <select id="productionProject" class="input-field" disabled>
                                        <option value="" disabled selected>Will be filled automatically...</option>
                                    </select>
                                </div>

                                <div class="input-group">
                                    <label class="input-label">Date</label>
                                    <input type="date" id="productionDate" class="input-field">
                                </div>

                                <div class="input-group">
                                    <label class="input-label">Shift</label>
                                    <select id="productionShift" class="input-field" onchange="saveProductionPreferences()">
                                        <option value="" disabled selected>Select shift...</option>
                                        <option value="First Shift">First Shift</option>
                                        <option value="Second Shift">Second Shift</option>
                                        <option value="Third Shift">Third Shift</option>
                                    </select>
                                </div>

                                <div class="input-group">
                                    <label class="input-label">Machine Name</label>
                                    <select id="productionMachine" class="input-field" onchange="onMachineChange()">
                                        <option value="" disabled selected>Select machine...</option>
                                        <!--   -->
                                        <option value="206">206</option>
                                        <option value="20.20">20.20</option>
                                        <option value="10.10">10.10</option>
                                        <option value="Cropping">Cropping</option>
                                        <option value="Manual Plasma">Manual Plasma</option>
                                        <option value="Press">Press</option>
                                        <option value="Drill">Drill</option>
                                        <option value="Chamfering">Chamfering</option>
                                        <!--   -->
                                        <option value="Shear">Shear</option>
                                        <option value="83P">83P</option>
                                        <option value="CNC Bending">CNC Bending</option>
                                        <!--   -->
                                        <option value="Finishing">Finishing</option>
                                    </select>
                                </div>

                                <div class="input-group">
                                    <label class="input-label">Operator Name</label>
                                    <select id="productionOperatorSelect" class="input-field" onchange="saveProductionPreferences()">
                                        <option value="" disabled selected>Select operator...</option>
                                    </select>
                                    <div class="mt-2">
                                        <button onclick="showOperatorsManagement()" class="btn btn-outline btn-sm w-full">
                                            <i class="fa-solid fa-users-gear"></i> Manage Operators
                                        </button>
                                    </div>
                                </div>

                                <div id="availableItemsContainer" class="hidden">
                                    <div class="input-group">
                                        <div class="flex justify-between items-center mb-1">
                                            <label class="input-label">Select Item for Production</label>
                                            <span id="remainingQuantityInfo" class="text-xs text-gray-500"></span>
                                        </div>
                                        <select id="availableItemsSelect" class="input-field" onchange="updateQuantityField()">
                                            <option value="" disabled selected>Select item...</option>
                                        </select>
                                        <div id="itemDetails" class="mt-3 p-3 bg-blue-50 rounded-lg hidden">
                                            <div class="grid grid-cols-2 gap-3 text-sm">
                                                <div>
                                                    <span class="font-bold text-gray-600">Section:</span>
                                                    <span id="selectedItemSection" class="ml-2 text-gray-800"></span>
                                                </div>
                                                <div>
                                                    <span class="font-bold text-gray-600">Operation:</span>
                                                    <span id="selectedItemOperation" class="ml-2 text-gray-800"></span>
                                                </div>
                                                <div>
                                                    <span class="font-bold text-gray-600">Total Qty:</span>
                                                    <span id="selectedItemTotal" class="ml-2 text-gray-800"></span>
                                                </div>
                                                <div>
                                                    <span class="font-bold text-gray-600">Completed:</span>
                                                    <span id="selectedItemCompleted" class="ml-2 text-gray-800"></span>
                                                </div>
                                                <div>
                                                    <span class="font-bold text-gray-600">Remaining:</span>
                                                    <span id="selectedItemRemaining" class="ml-2 text-gray-800"></span>
                                                </div>
                                                <div>
                                                    <span class="font-bold text-gray-600">Weight/Piece:</span>
                                                    <span id="selectedItemWeight" class="ml-2 text-gray-800"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="input-group">
                                    <label class="input-label">Quantity Produced</label>
                                    <input type="number" id="productionQuantity" min="1" value="1" class="input-field" onchange="validateQuantity()">
                                    <div id="quantityWarning" class="error-message hidden"></div>
                                </div>

                                <div class="input-group">
                                    <label class="input-label">Notes</label>
                                    <textarea id="productionNotes" rows="2" placeholder="Additional notes..." class="input-field"></textarea>
                                </div>

                                <button type="button" onclick="recordProduction()" class="btn btn-primary w-full">
                                    <i class="fa-solid fa-floppy-disk"></i> Record Production
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Production Stats -->
                    <div class="card">
                        <div class="card-body">
                            <h3 class="font-bold text-gray-700 mb-4">Production Statistics</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center">
                                    <span id="totalProductionRecords" class="block text-2xl font-bold text-purple-600">0</span>
                                    <span class="text-xs text-gray-500">Production Records</span>
                                </div>
                                <div class="text-center">
                                    <span id="totalProducedItems" class="block text-2xl font-bold text-indigo-600">0</span>
                                    <!--      Items Produced  Pieces Produced -->
                                    <span class="text-xs text-gray-500">Pieces Produced</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Production Results -->
                <section class="lg:col-span-8 space-y-6">
                    <!-- Production Records -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-xl font-bold">
                                <i class="fa-solid fa-chart-line mr-2 text-purple-600"></i> Production Records
                            </h2>
                            <div class="relative">
                                <input type="text" id="productionSearch" onkeyup="renderProductionList()" placeholder="Search production records..." class="input-field w-64">
                                <i class="fa-solid fa-search absolute right-3 top-3 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="productionContainer" class="space-y-4">
                                <p class="text-center text-gray-500 py-10">No production records. Record daily production.</p>
                            </div>

                            <!-- Production Detail View -->
                            <div id="productionDetailsView" class="hidden fade-in mt-8">
                                <div class="card-header">
                                    <div>
                                        <h3 class="text-xl font-bold">
                                            <i class="fa-solid fa-clipboard-check mr-2 text-purple-600"></i>
                                            Production Record Details: <span id="productionTitle"></span>
                                        </h3>
                                        <div class="flex gap-2 mt-2">
                                            <span id="productionType" class="badge badge-info"></span>
                                            <span id="productionShiftBadge" class="badge badge-warning"></span>
                                            <span id="productionDateBadge" class="badge badge-success"></span>
                                        </div>
                                    </div>
                                    <div class="action-buttons">
                                        <button onclick="exportProductionToExcel()" class="btn btn-secondary btn-sm">
                                            <i class="fa-solid fa-file-excel"></i> Excel
                                        </button>
                                        <button onclick="exportProductionToPDF()" class="btn btn-danger btn-sm">
                                            <i class="fa-solid fa-file-pdf"></i> PDF
                                        </button>
                                        <button onclick="hideProductionDetails()" class="btn btn-outline btn-sm">
                                            <i class="fa-solid fa-times"></i> Close
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="card bg-gray-50 mb-6">
                                        <div class="card-body">
                                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                                <div>
                                                    <span class="text-sm text-gray-500">Project:</span>
                                                    <span id="productionProjectDetail" class="font-bold block"></span>
                                                </div>
                                                <div>
                                                    <span class="text-sm text-gray-500">Machine:</span>
                                                    <span id="productionMachineDetail" class="font-bold block"></span>
                                                </div>
                                                <div>
                                                    <span class="text-sm text-gray-500">Quantity Produced:</span>
                                                    <span id="productionQuantityDetail" class="font-bold block"></span>
                                                </div>
                                                <div>
                                                    <span class="text-sm text-gray-500">Operator:</span>
                                                    <span id="productionOperatorDetail" class="font-bold block"></span>
                                                </div>
                                                <div>
                                                    <span class="text-sm text-gray-500">Weight Produced:</span>
                                                    <span id="productionWeightDetail" class="font-bold block"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-container">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Item Name</th>
                                                    <th>Section</th>
                                                    <th>Operation</th>
                                                    <th>Status</th>
                                                    <th>Quantity</th>
                                                    <th>Weight Produced</th>
                                                </tr>
                                            </thead>
                                            <tbody id="productionDetailsTableBody">
                                                <!-- Dynamic content -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reportsSection" class="hidden space-y-6">
            <div class="card">
                <div class="card-header">
                    <h2 class="text-xl font-bold">
                        <i class="fa-solid fa-chart-column mr-2 text-teal-600"></i> Reports
                    </h2>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <!-- Items Status Report -->
                        <div class="card">
                            <div class="card-body">
                                <h3 class="text-lg font-bold mb-4">
                                    <i class="fa-solid fa-clipboard-list mr-2 text-blue-600"></i> Items Status Report
                                </h3>
                                <p class="text-gray-600 mb-4">Get detailed status of items in a specific work order</p>
                                
                                <div class="space-y-4">
                                    <div class="input-group">
                                        <label class="input-label">Select Work Order</label>
                                        <select id="reportWorkOrder" class="input-field">
                                            <option value="" disabled selected>Select work order...</option>
                                        </select>
                                    </div>
                                    
                                    <button onclick="generateItemsStatusReport()" class="btn btn-primary w-full">
                                        <i class="fa-solid fa-file-export"></i> Generate Items Status Report
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Item Report -->
                        <div class="card">
                            <div class="card-body">
                                <h3 class="text-lg font-bold mb-4">
                                    <i class="fa-solid fa-magnifying-glass mr-2 text-purple-600"></i> Detailed Item Report
                                </h3>
                                <p class="text-gray-600 mb-4">Get detailed production record for a specific item</p>
                                
                                <div class="space-y-4">
                                    <div class="input-group">
                                        <label class="input-label">Select Work Order</label>
                                        <select id="detailReportWorkOrder" class="input-field" onchange="populateItemsForReport()">
                                            <option value="" disabled selected>Select work order...</option>
                                        </select>
                                    </div>
                                    
                                    <div id="itemSelectionContainer" class="hidden">
                                        <!--         -->
                                        <div class="input-group">
                                            <label class="input-label">Select Item</label>
                                            <select id="detailReportItem" class="input-field">
                                                <option value="" disabled selected>Select item...</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <button onclick="generateDetailedItemReport()" class="btn btn-primary w-full">
                                        <i class="fa-solid fa-chart-line"></i> Generate Detailed Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Production Report -->
                    <div class="card mb-8">
                        <div class="card-header">
                            <h3 class="text-lg font-bold">
                                <i class="fa-solid fa-calendar-day mr-2 text-teal-600"></i> Daily Production Report
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div class="input-group">
                                    <label class="input-label">From Date</label>
                                    <input type="date" id="dailyReportFromDate" class="input-field">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">To Date</label>
                                    <input type="date" id="dailyReportToDate" class="input-field">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="input-group">
                                    <label class="input-label">Shift</label>
                                    <select id="dailyReportShift" class="input-field">
                                        <option value="">All Shifts</option>
                                        <option value="First Shift">First Shift</option>
                                        <option value="Second Shift">Second Shift</option>
                                        <option value="Third Shift">Third Shift</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Operation Phase</label>
                                    <select id="dailyReportPhase" class="input-field">
                                        <option value="">All Phases</option>
                                        <option value="minimum">Minimum</option>
                                        <option value="crop">Cropping</option>
                                        <option value="cut">Cutting</option>
                                        <option value="bend">Bending</option>
                                        <option value="drill">Drilling</option>
                                        <option value="chamfer">Chamfering</option>
                                        <option value="finish">Finishing</option>
                                        <option value="shear">Shearing</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Machine</label>
                                    <select id="dailyReportMachine" class="input-field">
                                        <option value="">All Machines</option>
                                        <option value="206">206</option>
                                        <option value="20.20">20.20</option>
                                        <option value="10.10">10.10</option>
                                        <option value="Cropping">Cropping</option>
                                        <option value="Manual Plasma">Manual Plasma</option>
                                        <option value="Press">Press</option>
                                        <option value="Drill">Drill</option>
                                        <option value="Chamfering">Chamfering</option>
                                        <option value="Finishing">Finishing</option>
                                        <!--   -->
                                        <option value="Shear">Shear</option>
                                        <option value="83P">83P</option>
                                        <option value="CNC Bending">CNC Bending</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">Work Order</label>
                                <select id="dailyReportWorkOrder" class="input-field">
                                    <option value="">All Work Orders</option>
                                </select>
                            </div>
                            
                            <button onclick="generateDailyProductionReport()" class="btn btn-primary w-full">
                                <i class="fa-solid fa-chart-bar"></i> Generate Daily Production Report
                            </button>
                        </div>
                    </div>

                    <!-- Backup Section -->
                    <div class="card mb-8">
                        <div class="card-header">
                            <h3 class="text-lg font-bold">
                                <i class="fa-solid fa-database mr-2 text-orange-600"></i> Backup & Restore
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="card backup-card">
                                    <div class="card-body text-center">
                                        <i class="fa-solid fa-download text-4xl text-blue-500 mb-4"></i>
                                        <h4 class="font-bold text-lg mb-2">Export Backup</h4>
                                        <p class="text-gray-600 mb-4 text-sm">Save all system data in a single file</p>
                                        <button onclick="exportBackup()" class="btn btn-primary w-full">
                                            <i class="fa-solid fa-file-export"></i> Export Data
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="card backup-card">
                                    <div class="card-body text-center">
                                        <i class="fa-solid fa-upload text-4xl text-green-500 mb-4"></i>
                                        <h4 class="font-bold text-lg mb-2">Restore Backup</h4>
                                        <p class="text-gray-600 mb-4 text-sm">Restore data from a backup file</p>
                                        <div class="text-center">
                                            <div class="backup-card p-4 rounded-lg mb-4 cursor-pointer" onclick="document.getElementById('restoreFile').click()">
                                                <i class="fa-solid fa-cloud-arrow-up text-2xl text-gray-400 mb-2"></i>
                                                <p class="text-sm font-medium text-gray-700">Click to upload backup file</p>
                                                <input type="file" id="restoreFile" accept=".json" class="hidden" onchange="handleRestoreFile(event)">
                                            </div>
                                            <button onclick="restoreBackup()" class="btn btn-secondary w-full" id="restoreBtn" disabled>
                                                <i class="fa-solid fa-file-import"></i> Restore Data
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Report Results -->
                    <div id="reportResults" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="text-lg font-bold" id="reportTitle"></h3>
                                <div class="action-buttons">
                                    <button onclick="exportReportToExcel()" class="btn btn-secondary btn-sm">
                                        <i class="fa-solid fa-file-excel"></i> Excel
                                    </button>
                                    <button onclick="exportReportToPDF()" class="btn btn-danger btn-sm">
                                        <i class="fa-solid fa-file-pdf"></i> PDF
                                    </button>
                                    <button onclick="printReport()" class="btn btn-warning btn-sm">
                                        <i class="fa-solid fa-print"></i> Print
                                    </button>
                                    <button onclick="hideReportResults()" class="btn btn-outline btn-sm">
                                        <i class="fa-solid fa-times"></i> Close
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table class="table">
                                        <thead id="reportTableHeader">
                                            <!-- Dynamic content -->
                                        </thead>
                                        <tbody id="reportTableBody">
                                            <!-- Dynamic content -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Backup Modal -->
    <div class="modal" id="backupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-lg font-bold">
                    <i class="fa-solid fa-database mr-2"></i> Backup Management
                </h3>
                <button onclick="hideModal('backupModal')" class="btn btn-outline btn-sm">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="space-y-4">
                    <div class="input-group">
                        <label class="input-label">Create Backup</label>
                        <p class="text-sm text-gray-600 mb-3">Save all system data to a JSON file</p>
                        <button onclick="createBackup()" class="btn btn-primary w-full">
                            <i class="fa-solid fa-download"></i> Create Backup
                        </button>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Restore Backup</label>
                        <p class="text-sm text-gray-600 mb-3">Restore data from a backup file</p>
                        <input type="file" id="backupFile" accept=".json" class="input-field" onchange="handleBackupFileChange()">
                        <button onclick="restoreFromBackup()" class="btn btn-secondary w-full mt-2" id="restoreBackupBtn" disabled>
                            <i class="fa-solid fa-upload"></i> Restore Backup
                        </button>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">Backup Schedule</label>
                        <p class="text-sm text-gray-600 mb-3">Set automatic backup timing</p>
                        <select id="backupSchedule" class="input-field">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="none">None</option>
                        </select>
                        <button onclick="setBackupSchedule()" class="btn btn-outline w-full mt-2">
                            <i class="fa-solid fa-calendar-check"></i> Save Schedule
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="hideModal('backupModal')" class="btn btn-outline">Close</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="modal" id="loadingModal">
        <div class="modal-content" style="background: transparent; box-shadow: none;">
            <div class="text-center">
                <div class="spinner mx-auto mb-4"></div>
                <p class="text-white font-medium" id="loadingText">Processing...</p>
            </div>
        </div>
    </div>

    <!-- Scroll to top button -->
    <div class="scroll-to-top hidden" id="scrollToTop" onclick="scrollToTop()">
        <i class="fa-solid fa-arrow-up"></i>
    </div>

    <script>
        // ============= GLOBAL VARIABLES =============
        const appConfig = {
            version: '2.0.0',
            backupSchedule: localStorage.getItem('backupSchedule') || 'none',
            lastBackup: localStorage.getItem('lastBackup') || null,
            settings: JSON.parse(localStorage.getItem('appSettings')) || {
                autoBackup: false,
                theme: 'light'
            }
        };

        let currentExcelData = [];
        let currentWorkOrderData = [];
        let currentBackupData = null;
        let currentWorkOrder = null;
        let currentProduction = null;
        let currentAvailableItems = [];
        let selectedWorkOrderItems = [];
        let allItemsForReport = [];

        // Databases
        let db = JSON.parse(localStorage.getItem('towerDB')) || [];
        let workOrdersDB = JSON.parse(localStorage.getItem('workOrdersDB')) || [];
        let productionDB = JSON.parse(localStorage.getItem('productionDB')) || [];
        let machineOperatorsDB = JSON.parse(localStorage.getItem('machineOperatorsDB')) || {};

        // Production Preferences
        let productionPreferences = JSON.parse(localStorage.getItem('productionPreferences')) || {
            towerType: '',
            model: '',
            workOrderId: '',
            shift: '',
            machine: '',
            operator: '',
            date: new Date().toISOString().split('T')[0]
        };

        // ============= INITIALIZATION =============
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setBackupScheduleInterval();
            setupScrollToTop();
            //   setupSearchableDropdown     
        });

        function initializeApp() {
            updateStats();
            renderModelsList();
            renderWorkOrdersList();
            renderProductionList();
            populateTowerTypeDropdown();
            populateReportDropdowns();
            populateDailyReportWorkOrders();
            
            document.getElementById('productionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('dailyReportFromDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('dailyReportToDate').value = new Date().toISOString().split('T')[0];
            
            // Update operators dropdown
            updateOperatorsDropdown();
            
            // Set models as default tab
            switchTab('models');
            
            // Check for scheduled backups
            checkScheduledBackup();
            
            // Show welcome message
            showToast('Welcome to Tower Manufacturing Management System!', 'info');
        }

        function setupScrollToTop() {
            const scrollToTopBtn = document.getElementById('scrollToTop');
            
            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    scrollToTopBtn.classList.remove('hidden');
                } else {
                    scrollToTopBtn.classList.add('hidden');
                }
            });
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // ============= BACKUP & RESTORE SYSTEM =============
        function showBackupModal() {
            showModal('backupModal');
        }

        function createBackup() {
            try {
                showLoading('Creating backup...');
                
                const backupData = {
                    version: appConfig.version,
                    timestamp: new Date().toISOString(),
                    data: {
                        towerDB: db,
                        workOrdersDB: workOrdersDB,
                        productionDB: productionDB,
                        machineOperatorsDB: machineOperatorsDB,
                        productionPreferences: productionPreferences,
                        appSettings: appConfig.settings
                    }
                };

                // Create blob and download
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tower-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Update last backup time
                appConfig.lastBackup = new Date().toISOString();
                localStorage.setItem('lastBackup', appConfig.lastBackup);

                hideLoading();
                showToast('Backup created successfully', 'success');

            } catch (error) {
                hideLoading();
                showToast('Error creating backup', 'error');
                console.error('Backup error:', error);
            }
        }

        function handleBackupFileChange() {
            const fileInput = document.getElementById('backupFile');
            const restoreBtn = document.getElementById('restoreBackupBtn');
            
            if (fileInput.files.length > 0) {
                restoreBtn.disabled = false;
            }
        }

        function restoreFromBackup() {
            const fileInput = document.getElementById('backupFile');
            
            if (!fileInput.files.length) {
                showToast('Please select backup file', 'warning');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    showLoading('Restoring data...');
                    
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validate backup file structure
                    if (!backupData.version || !backupData.data) {
                        throw new Error('Invalid backup file');
                    }

                    // Confirm restoration
                    if (!confirm('All current data will be replaced with backup data. Are you sure?')) {
                        hideLoading();
                        return;
                    }

                    // Restore data
                    db = backupData.data.towerDB || [];
                    workOrdersDB = backupData.data.workOrdersDB || [];
                    productionDB = backupData.data.productionDB || [];
                    machineOperatorsDB = backupData.data.machineOperatorsDB || {};
                    productionPreferences = backupData.data.productionPreferences || {};
                    appConfig.settings = backupData.data.appSettings || appConfig.settings;

                    // Save to localStorage
                    saveAllData();

                    // Update UI
                    updateStats();
                    renderModelsList();
                    renderWorkOrdersList();
                    renderProductionList();
                    populateTowerTypeDropdown();
                    populateReportDropdowns();
                    populateDailyReportWorkOrders();
                    updateOperatorsDropdown();

                    hideLoading();
                    showToast('Data restored successfully', 'success');
                    hideModal('backupModal');

                } catch (error) {
                    hideLoading();
                    showToast('Backup file is corrupted or invalid', 'error');
                    console.error('Restore error:', error);
                }
            };

            reader.readAsText(file);
        }

        function setBackupSchedule() {
            const schedule = document.getElementById('backupSchedule').value;
            appConfig.backupSchedule = schedule;
            localStorage.setItem('backupSchedule', schedule);
            showToast('Backup schedule saved', 'success');
        }

        function checkScheduledBackup() {
            if (appConfig.backupSchedule === 'none') return;

            const now = new Date();
            const lastBackup = appConfig.lastBackup ? new Date(appConfig.lastBackup) : null;
            let shouldBackup = false;

            if (!lastBackup) {
                shouldBackup = true;
            } else {
                const diff = now - lastBackup;
                const days = diff / (1000 * 60 * 60 * 24);

                switch (appConfig.backupSchedule) {
                    case 'daily':
                        shouldBackup = days >= 1;
                        break;
                    case 'weekly':
                        shouldBackup = days >= 7;
                        break;
                    case 'monthly':
                        shouldBackup = days >= 30;
                        break;
                }
            }

            if (shouldBackup) {
                showToast('Scheduled backup time has arrived', 'warning');
            }
        }

        function setBackupScheduleInterval() {
            // Check every hour for scheduled backups
            setInterval(checkScheduledBackup, 60 * 60 * 1000);
        }

        function exportBackup() {
            createBackup();
        }

        function handleRestoreFile(event) {
            const file = event.target.files[0];
            if (file) {
                currentBackupData = file;
                document.getElementById('restoreBtn').disabled = false;
                showToast('Backup file loaded', 'success');
            }
        }

        function restoreBackup() {
            if (!currentBackupData) {
                showToast('Please upload backup file first', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    restoreFromBackupData(backup);
                } catch (error) {
                    showToast('Backup file is corrupted', 'error');
                }
            };
            reader.readAsText(currentBackupData);
        }

        function restoreFromBackupData(backupData) {
            if (confirm('All current data will be replaced. Are you sure?')) {
                db = backupData.db || [];
                workOrdersDB = backupData.workOrdersDB || [];
                productionDB = backupData.productionDB || [];
                machineOperatorsDB = backupData.machineOperatorsDB || {};
                
                saveAllData();
                updateStats();
                renderModelsList();
                renderWorkOrdersList();
                renderProductionList();
                populateDailyReportWorkOrders();
                updateOperatorsDropdown();
                
                showToast('Data restored successfully', 'success');
            }
        }

        // ============= OPERATORS MANAGEMENT SYSTEM =============
        function showOperatorsManagement() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="text-lg font-bold">
                            <i class="fa-solid fa-users mr-2"></i> Machine Operators Management
                        </h3>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn btn-outline btn-sm">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="space-y-4">
                            <div class="input-group">
                                <label class="input-label">Select Machine</label>
                                <select id="operatorMachineSelect" class="input-field" onchange="loadOperatorsForMachine()">
                                    <option value="" disabled selected>Select machine...</option>
                                    <option value="206">206</option>
                                    <option value="20.20">20.20</option>
                                    <option value="10.10">10.10</option>
                                    <option value="Cropping">Cropping</option>
                                    <option value="Manual Plasma">Manual Plasma</option>
                                    <option value="Press">Press</option>
                                    <option value="Drill">Drill</option>
                                    <option value="Chamfering">Chamfering</option>
                                    <option value="Finishing">Finishing</option>
                                    <!--   -->
                                    <option value="Shear">Shear</option>
                                    <option value="83P">83P</option>
                                    <option value="CNC Bending">CNC Bending</option>
                                </select>
                            </div>
                            
                            <div id="operatorsListContainer" class="hidden">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="input-label">Operators for this machine</label>
                                    <button onclick="addOperatorField()" class="btn btn-primary btn-sm">
                                        <i class="fa-solid fa-plus"></i> Add Operator
                                    </button>
                                </div>
                                <div id="operatorsList" class="space-y-2">
                                    <!-- Dynamic operators list -->
                                </div>
                                <button onclick="saveOperators()" class="btn btn-secondary w-full mt-4">
                                    <i class="fa-solid fa-save"></i> Save Operators
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function loadOperatorsForMachine() {
            const machine = document.getElementById('operatorMachineSelect').value;
            const container = document.getElementById('operatorsListContainer');
            const list = document.getElementById('operatorsList');
            
            if (!machine) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            list.innerHTML = '';
            
            // Load operators from database
            const operators = machineOperatorsDB[machine] || [];
            
            operators.forEach((operator, index) => {
                const div = document.createElement('div');
                div.className = 'flex gap-2 items-center';
                div.innerHTML = `
                    <input type="text" value="${operator}" class="input-field flex-1 operator-name" placeholder="Operator name">
                    <button onclick="removeOperator(this)" class="btn btn-danger btn-sm">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                list.appendChild(div);
            });
            
            // If no operators, add empty field
            if (operators.length === 0) {
                addOperatorField();
            }
        }

        function addOperatorField() {
            const list = document.getElementById('operatorsList');
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-center';
            div.innerHTML = `
                <input type="text" class="input-field flex-1 operator-name" placeholder="Enter operator name">
                <button onclick="removeOperator(this)" class="btn btn-danger btn-sm">
                    <i class="fa-solid fa-trash"></i>
                </button>
            `;
            list.appendChild(div);
        }

        function removeOperator(button) {
            button.parentElement.remove();
        }

        function saveOperators() {
            const machine = document.getElementById('operatorMachineSelect').value;
            const operatorInputs = document.querySelectorAll('.operator-name');
            const operators = [];
            
            operatorInputs.forEach(input => {
                if (input.value.trim()) {
                    operators.push(input.value.trim());
                }
            });
            
            machineOperatorsDB[machine] = operators;
            localStorage.setItem('machineOperatorsDB', JSON.stringify(machineOperatorsDB));
            showToast('Operators saved successfully', 'success');
            
            // Update operators dropdown in production form
            updateOperatorsDropdown();
        }

        function updateOperatorsDropdown() {
            const machine = document.getElementById('productionMachine').value;
            const operatorSelect = document.getElementById('productionOperatorSelect');
            
            if (!machine) {
                operatorSelect.innerHTML = '<option value="" disabled selected>Select machine first...</option>';
                return;
            }
            
            const operators = machineOperatorsDB[machine] || [];
            operatorSelect.innerHTML = '<option value="" disabled selected>Select operator...</option>';
            
            operators.forEach(operator => {
                const option = document.createElement('option');
                option.value = operator;
                option.textContent = operator;
                operatorSelect.appendChild(option);
            });
            
            // If there's a saved operator in preferences, select it
            if (productionPreferences.operator && operators.includes(productionPreferences.operator)) {
                operatorSelect.value = productionPreferences.operator;
            }
        }

        // ============= PDF EXPORT =============
        function exportModelToPDF() {
            const model = db.find(m => m.model === document.getElementById('viewTitle').textContent);
            if (!model) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add logo and title
            doc.setFontSize(20);
            doc.text('Tower Model Report', 105, 20, null, null, 'center');
            
            doc.setFontSize(12);
            doc.text(`Model: ${model.model}`, 20, 40);
            doc.text(`Type: ${model.type}`, 20, 50);
            doc.text(`Creation Date: ${model.date}`, 20, 60);
            doc.text(`Number of Items: ${model.items.length}`, 20, 70);
            
            // Create table
            const tableData = model.items.map((item, index) => [
                index + 1,
                item.itemName,
                item.section,
                item.steelGrade || '-',
                item.operations.map(op => op.name).join(', ')
            ]);
            
            doc.autoTable({
                startY: 80,
                head: [['#', 'Item Name', 'Section', 'Steel Grade', 'Operations']],
                body: tableData,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] }
            });
            
            // Save PDF
            doc.save(`Model-${model.model}.pdf`);
            showToast('Model exported to PDF', 'success');
        }

        function exportWorkOrderToPDF() {
            if (!currentWorkOrder) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(18);
            doc.text('Work Order Report', 105, 20, null, null, 'center');
            
            doc.setFontSize(11);
            doc.text(`Work Order Name: ${currentWorkOrder.workOrderName}`, 20, 35);
            doc.text(`Project: ${currentWorkOrder.projectName}`, 20, 45);
            doc.text(`Sales Order Number: ${currentWorkOrder.salesOrderNumber}`, 20, 55);
            doc.text(`Type: ${currentWorkOrder.type}`, 20, 65);
            doc.text(`Model: ${currentWorkOrder.model}`, 20, 75);
            doc.text(`Creation Date: ${currentWorkOrder.date}`, 20, 85);
            
            // Calculate statistics including weight
            const totalItems = currentWorkOrder.items.length;
            const completedItems = currentWorkOrder.items.filter(item => item.status === 'Completed').length;
            const progress = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
            const totalWeight = currentWorkOrder.items.reduce((sum, item) => sum + (parseFloat(item.totalWeight) || 0), 0);
            
            doc.text(`Total Items: ${totalItems}`, 130, 35);
            doc.text(`Completed Items: ${completedItems}`, 130, 45);
            doc.text(`Progress: ${progress}%`, 130, 55);
            doc.text(`Total Weight: ${totalWeight.toFixed(2)} kg`, 130, 65);
            
            // Table with weight columns
            const tableData = currentWorkOrder.items.map((item, index) => [
                index + 1,
                item.itemName,
                item.section,
                item.steelGrade || '-',
                item.length || '-',
                item.quantity,
                item.weightPerPiece || '-',
                item.totalWeight || '-',
                item.completedQuantity || 0,
                item.quantity - (item.completedQuantity || 0),
                item.status || 'In Progress'
            ]);
            
            doc.autoTable({
                startY: 95,
                head: [['#', 'Item Name', 'Section', 'Steel Grade', 'Length', 'Quantity', 'Weight/Piece', 'Total Weight', 'Completed', 'Remaining', 'Status']],
                body: tableData,
                theme: 'grid',
                styles: { fontSize: 7 },
                headStyles: { fillColor: [16, 185, 129] }
            });
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Page ${i} of ${pageCount}`, 105, 285, null, null, 'center');
                doc.text(`Print Date: ${new Date().toLocaleDateString()}`, 195, 285, null, null, 'right');
            }
            
            doc.save(`Work-Order-${currentWorkOrder.workOrderName}.pdf`);
            showToast('Work order exported to PDF', 'success');
        }

        function exportProductionToPDF() {
            if (!currentProduction) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text('Production Record Report', 105, 20, null, null, 'center');
            
            doc.setFontSize(11);
            doc.text(`Item: ${currentProduction.itemName}`, 20, 35);
            doc.text(`Project: ${currentProduction.projectName}`, 20, 45);
            doc.text(`Work Order: ${currentProduction.workOrderName}`, 20, 55);
            doc.text(`Machine: ${currentProduction.machine}`, 20, 65);
            doc.text(`Operation: ${currentProduction.operation}`, 20, 75);
            doc.text(`Operator: ${currentProduction.operator}`, 20, 85);
            doc.text(`Quantity: ${currentProduction.quantity}`, 130, 35);
            doc.text(`Weight Produced: ${currentProduction.producedWeight || '0'} kg`, 130, 45);
            doc.text(`Shift: ${currentProduction.shift}`, 130, 55);
            doc.text(`Date: ${currentProduction.date}`, 130, 65);
            doc.text(`Time: ${new Date(currentProduction.timestamp).toLocaleTimeString()}`, 130, 75);
            
            // Add notes if exists
            if (currentProduction.notes) {
                doc.text(`Notes: ${currentProduction.notes}`, 20, 95);
            }
            
            // Add reference number
            doc.setFontSize(10);
            doc.text(`Record ID: ${currentProduction.id}`, 105, 120, null, null, 'center');
            
            doc.save(`Production-${currentProduction.itemName}-${currentProduction.date}.pdf`);
            showToast('Production record exported to PDF', 'success');
        }

        function exportReportToPDF() {
            const title = document.getElementById('reportTitle').textContent;
            const headers = Array.from(document.querySelectorAll('#reportTableHeader th')).map(th => th.textContent);
            const rows = Array.from(document.querySelectorAll('#reportTableBody tr')).map(tr => 
                Array.from(tr.querySelectorAll('td')).map(td => td.textContent)
            );

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text(title, 105, 20, null, null, 'center');
            
            doc.autoTable({
                startY: 30,
                head: [headers],
                body: rows,
                theme: 'grid',
                styles: { fontSize: 9 },
                headStyles: { fillColor: [139, 92, 246] }
            });
            
            doc.save(`Report-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('Report exported to PDF', 'success');
        }

        // ============= UTILITY FUNCTIONS =============
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function showLoading(text = 'Processing...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingModal').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingModal').classList.remove('active');
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fa-solid ${getToastIcon(type)}"></i>
                <span>${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fa-solid fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        function getToastIcon(type) {
            switch (type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                default: return 'fa-info-circle';
            }
        }

        function switchTab(tabName) {
            // Hide all sections
            document.querySelectorAll('section[id$="Section"]').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section and activate tab
            document.getElementById(`${tabName}Section`).classList.remove('hidden');
            document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
            
            // Update specific tab content
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'workOrder') {
                populateTowerTypeDropdown();
            } else if (tabName === 'production') {
                populateProductionTowerTypeDropdown();
                loadProductionPreferences();
            } else if (tabName === 'reports') {
                populateReportDropdowns();
                populateDailyReportWorkOrders();
            }
        }

        function saveAllData() {
            localStorage.setItem('towerDB', JSON.stringify(db));
            localStorage.setItem('workOrdersDB', JSON.stringify(workOrdersDB));
            localStorage.setItem('productionDB', JSON.stringify(productionDB));
            localStorage.setItem('machineOperatorsDB', JSON.stringify(machineOperatorsDB));
            localStorage.setItem('productionPreferences', JSON.stringify(productionPreferences));
            localStorage.setItem('appSettings', JSON.stringify(appConfig.settings));
        }

        // ============= CORE APPLICATION FUNCTIONS =============
        function updateStats() {
            document.getElementById('totalModels').textContent = db.length;
            const totalItems = db.reduce((acc, curr) => acc + curr.items.length, 0);
            document.getElementById('totalItems').textContent = totalItems;
            
            document.getElementById('totalWorkOrders').textContent = workOrdersDB.length;
            const workOrderItemsCount = workOrdersDB.reduce((acc, curr) => acc + curr.items.length, 0);
            document.getElementById('workOrderItems').textContent = workOrderItemsCount;
            
            document.getElementById('totalProductionRecords').textContent = productionDB.length;
            const totalProduced = productionDB.reduce((acc, curr) => acc + curr.quantity, 0);
            document.getElementById('totalProducedItems').textContent = totalProduced;
            
            updateDashboard();
        }

        function updateDashboard() {
            // Calculate statistics
            const activeWorkOrders = workOrdersDB.filter(wo => {
                return wo.items.some(item => item.status !== 'Completed');
            }).length;
            
            const totalItemsInProduction = workOrdersDB.reduce((acc, wo) => {
                const incompleteItems = wo.items.filter(item => item.status !== 'Completed').length;
                return acc + incompleteItems;
            }, 0);
            
            const today = new Date().toLocaleDateString('en-US');
            const completedToday = productionDB.filter(record => 
                new Date(record.timestamp).toLocaleDateString('en-US') === today
            ).reduce((acc, record) => acc + record.quantity, 0);
            
            const pendingOperations = workOrdersDB.reduce((acc, wo) => {
                return acc + wo.items.reduce((itemAcc, item) => {
                    if (item.status !== 'Completed') {
                        const completedOps = Object.values(item.completedOperations || {}).filter(v => v).length;
                        return itemAcc + (item.operations.length - completedOps);
                    }
                    return itemAcc;
                }, 0);
            }, 0);
            
            // Update statistics
            document.getElementById('dashboardActiveWorkOrders').textContent = activeWorkOrders;
            document.getElementById('dashboardTotalItems').textContent = totalItemsInProduction;
            document.getElementById('dashboardCompletedToday').textContent = completedToday;
            document.getElementById('dashboardPendingOperations').textContent = pendingOperations;
            
            // Update progress bars
            const totalWorkOrders = workOrdersDB.length;
            document.getElementById('workOrdersProgress').style.width = totalWorkOrders > 0 ? 
                `${(activeWorkOrders / totalWorkOrders) * 100}%` : '0%';
            
            // Update recent production
            renderRecentProduction();
            
            // Update work orders progress
            renderWorkOrdersProgress();
        }

        function renderRecentProduction() {
            const container = document.getElementById('recentProductionContainer');
            const recent = productionDB.slice(-5).reverse(); // Last 5 records
            
            if (recent.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No recent production records</p>';
                return;
            }
            
            container.innerHTML = '';
            recent.forEach(record => {
                const time = new Date(record.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const card = document.createElement('div');
                card.className = 'card p-3';
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-gray-800">${record.itemName}</h4>
                            <div class="flex gap-2 mt-1">
                                <span class="badge badge-primary text-xs">${record.machine}</span>
                                <span class="badge badge-success text-xs">${record.quantity} pieces</span>
                                <span class="badge badge-warning text-xs">${record.producedWeight || '0'} kg</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-sm text-gray-500">${time}</span>
                            <br>
                            <span class="text-xs text-gray-400">${record.shift}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderWorkOrdersProgress() {
            const container = document.getElementById('workOrdersProgressContainer');
            const activeWorkOrders = workOrdersDB.filter(wo => {
                return wo.items.some(item => item.status !== 'Completed');
            });
            
            if (activeWorkOrders.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No active work orders</p>';
                return;
            }
            
            container.innerHTML = '';
            activeWorkOrders.forEach(wo => {
                const totalItems = wo.items.length;
                const completedItems = wo.items.filter(item => item.status === 'Completed').length;
                const progress = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
                
                const card = document.createElement('div');
                card.className = 'card p-4';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-gray-800">${wo.workOrderName}</h4>
                        <span class="font-bold ${progress === 100 ? 'text-green-600' : 'text-blue-600'}">${progress}%</span>
                    </div>
                    
                    <div class="mb-3">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>${wo.projectName}</span>
                            <span>${completedItems}/${totalItems} items</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="p-2 bg-gray-50 rounded">
                            <span class="text-gray-500">Model:</span>
                            <span class="font-bold block">${wo.model}</span>
                        </div>
                        <div class="p-2 bg-gray-50 rounded">
                            <span class="text-gray-500">Type:</span>
                            <span class="font-bold block">${wo.type}</span>
                        </div>
                    </div>
                    
                    <button onclick="showWorkOrderDetails(${wo.id})" class="btn btn-outline w-full mt-3 btn-sm">
                        <i class="fa-solid fa-eye"></i> View Details
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function clearDatabase() {
            if(confirm("Are you sure you want to clear all data? All models, work orders and production records will be deleted.")) {
                localStorage.clear();
                db = [];
                workOrdersDB = [];
                productionDB = [];
                machineOperatorsDB = {};
                productionPreferences = {
                    towerType: '',
                    model: '',
                    workOrderId: '',
                    shift: '',
                    machine: '',
                    operator: '',
                    date: new Date().toISOString().split('T')[0]
                };
                
                updateStats();
                updateDashboard();
                renderModelsList();
                renderWorkOrdersList();
                renderProductionList();
                hideDetails();
                
                showToast("Database cleared successfully", 'success');
            }
        }

        // ============= PRODUCTION PREFERENCES =============
        function saveProductionPreferences() {
            productionPreferences = {
                towerType: document.getElementById('productionTowerType').value,
                model: document.getElementById('productionModel').value,
                workOrderId: document.getElementById('productionWorkOrder').value,
                shift: document.getElementById('productionShift').value,
                machine: document.getElementById('productionMachine').value,
                operator: document.getElementById('productionOperatorSelect').value,
                date: document.getElementById('productionDate').value
            };
            
            localStorage.setItem('productionPreferences', JSON.stringify(productionPreferences));
            showToast('Preferences saved', 'success');
        }

        function loadProductionPreferences() {
            if (!productionPreferences) return;
            
            if (productionPreferences.towerType) {
                document.getElementById('productionTowerType').value = productionPreferences.towerType;
                populateProductionModelDropdown();
                
                setTimeout(() => {
                    if (productionPreferences.model) {
                        document.getElementById('productionModel').value = productionPreferences.model;
                        populateWorkOrderDropdown();
                        
                        setTimeout(() => {
                            if (productionPreferences.workOrderId) {
                                document.getElementById('productionWorkOrder').value = productionPreferences.workOrderId;
                                populateProjectDropdown();
                            }
                        }, 300);
                    }
                }, 300);
            }
            
            if (productionPreferences.shift) {
                document.getElementById('productionShift').value = productionPreferences.shift;
            }
            
            if (productionPreferences.machine) {
                document.getElementById('productionMachine').value = productionPreferences.machine;
                // Update operators dropdown for this machine
                updateOperatorsDropdown();
                
                setTimeout(() => {
                    if (productionPreferences.workOrderId && productionPreferences.machine) {
                        loadAvailableItems();
                    }
                }, 500);
            }
            
            if (productionPreferences.date) {
                document.getElementById('productionDate').value = productionPreferences.date;
            }
        }

        // ============= FILE HANDLING =============
        function handleFileSelect(event) {
            const file = event.target.files[0];
            const fileName = document.getElementById('fileName');
            
            if (file) {
                fileName.textContent = `File uploaded: ${file.name}`;
                fileName.classList.remove('hidden');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    currentExcelData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                };
                reader.readAsArrayBuffer(file);
                
                showToast('File loaded successfully', 'success');
            }
        }

        function handleWorkOrderFileSelect(event) {
            const file = event.target.files[0];
            const fileName = document.getElementById('workOrderFileName');
            
            if (file) {
                fileName.textContent = `File uploaded: ${file.name}`;
                fileName.classList.remove('hidden');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    currentWorkOrderData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                };
                reader.readAsArrayBuffer(file);
                
                showToast('Work order file loaded', 'success');
            }
        }

        // ============= DATA PROCESSING =============
        function processData() {
            const type = document.getElementById('towerType').value;
            const model = document.getElementById('modelName').value.trim();

            if (!type || !model) {
                showToast('Please select tower type and enter model name', 'warning');
                return;
            }

            if (!currentExcelData || currentExcelData.length === 0) {
                showToast('Please upload a valid Excel file', 'warning');
                return;
            }

            try {
                showLoading('Processing data...');
                
                const processedItems = [];
                
                for (let i = 1; i < currentExcelData.length; i++) {
                    const row = currentExcelData[i];
                    if (!row || row.length === 0) continue;

                    const itemName = row[0];
                    const section = row[1];
                    const steelGrade = row[2];
                    
                    if (!itemName || !section) continue;

                    const operations = [];
                    const opColumns = [row[3], row[4], row[5], row[6], row[7]];

                    opColumns.forEach((op) => {
                        if (op && op.trim() !== '') {
                            const machineInfo = getMachineForOperation(op, section);
                            operations.push({
                                name: op,
                                machine: machineInfo.machine,
                                type: machineInfo.type
                            });
                        }
                    });

                    if (operations.length > 0) {
                        processedItems.push({
                            itemName,
                            section,
                            steelGrade,
                            operations
                        });
                    }
                }

                if (processedItems.length === 0) {
                    hideLoading();
                    showToast('No valid data found in file', 'error');
                    return;
                }

                const newEntry = {
                    id: Date.now(),
                    type,
                    model,
                    date: new Date().toLocaleDateString(),
                    items: processedItems
                };

                // Remove existing model with same name
                db = db.filter(m => m.model !== model);
                db.push(newEntry);
                
                saveAllData();
                updateStats();
                renderModelsList();
                populateTowerTypeDropdown();
                populateProductionTowerTypeDropdown();
                
                // Reset form
                document.getElementById('uploadForm').reset();
                document.getElementById('fileName').classList.add('hidden');
                currentExcelData = [];
                
                hideLoading();
                showToast('Model data saved successfully', 'success');

            } catch (error) {
                hideLoading();
                showToast('Error processing data', 'error');
                console.error('Processing error:', error);
            }
        }

        function processWorkOrder() {
            const workOrderName = document.getElementById('workOrderName').value.trim();
            const projectName = document.getElementById('projectName').value.trim();
            const salesOrderNumber = document.getElementById('salesOrderNumber').value.trim();
            const type = document.getElementById('workOrderTowerType').value;
            const model = document.getElementById('workOrderModel').value;

            if (!workOrderName) {
                showToast('Please enter work order name', 'warning');
                return;
            }

            if (!projectName) {
                showToast('Please enter project name', 'warning');
                return;
            }

            if (!salesOrderNumber) {
                showToast('Please enter sales order number', 'warning');
                return;
            }

            if (!type || !model) {
                showToast('Please select tower type and model', 'warning');
                return;
            }

            if (!currentWorkOrderData || currentWorkOrderData.length === 0) {
                showToast('Please upload work order file', 'warning');
                return;
            }

            const existingWorkOrder = workOrdersDB.find(wo => wo.workOrderName === workOrderName);
            if (existingWorkOrder) {
                showToast('Work order name already exists. Please choose another name', 'warning');
                return;
            }

            const modelData = db.find(item => item.type === type && item.model === model);
            
            if (!modelData) {
                showToast('Selected model not found in database', 'error');
                return;
            }

            try {
                showLoading('Processing work order...');
                
                const workOrderItems = [];
                
                for (let i = 1; i < currentWorkOrderData.length; i++) {
                    const row = currentWorkOrderData[i];
                    if (!row || row.length < 7) continue;

                    const itemName = row[0];
                    const section = row[1];
                    const steelGrade = row[2];
                    const length = row[3];
                    const weightPerPiece = parseFloat(row[4]) || 0;
                    const quantity = parseInt(row[5]) || 0;
                    const totalWeight = parseFloat(row[6]) || (weightPerPiece * quantity);

                    let matchingItem = modelData.items.find(item => item.itemName === itemName);
                    
                    let operations = [];
                    if (matchingItem) {
                        operations = matchingItem.operations;
                    } else {
                        matchingItem = modelData.items.find(item => item.section === section);
                        if (matchingItem) {
                            operations = matchingItem.operations;
                        } else {
                            operations = [{
                                name: "No specific operations",
                                machine: "To be determined later",
                                type: "General"
                            }];
                        }
                    }

                    // Initialize completed operations
                    const completedOperations = {};
                    operations.forEach(op => {
                        completedOperations[op.name] = {
                            completed: false,
                            completedQuantity: 0,
                            totalRequired: quantity
                        };
                    });

                    workOrderItems.push({
                        itemName,
                        section,
                        steelGrade,
                        length,
                        weightPerPiece,
                        quantity,
                        totalWeight,
                        operations,
                        completedOperations,
                        completedQuantity: 0,
                        status: 'In Progress'
                    });
                }

                if (workOrderItems.length === 0) {
                    hideLoading();
                    showToast('No valid data found in file', 'error');
                    return;
                }

                const workOrder = {
                    id: Date.now(),
                    workOrderName,
                    projectName,
                    salesOrderNumber,
                    type,
                    model,
                    date: new Date().toLocaleDateString(),
                    creationTime: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    timestamp: Date.now(),
                    items: workOrderItems,
                    fileName: document.getElementById('workOrderFile').files[0]?.name || "Unknown"
                };

                workOrdersDB.push(workOrder);
                localStorage.setItem('workOrdersDB', JSON.stringify(workOrdersDB));
                
                currentWorkOrder = workOrder;
                
                // Reset form
                document.getElementById('workOrderForm').reset();
                document.getElementById('workOrderFileName').classList.add('hidden');
                currentWorkOrderData = [];
                populateTowerTypeDropdown();
                populateProductionTowerTypeDropdown();
                populateDailyReportWorkOrders();
                
                updateStats();
                updateDashboard();
                renderWorkOrdersList();
                showWorkOrderDetails(workOrder.id);
                
                hideLoading();
                showToast('Work order processed successfully', 'success');

            } catch (error) {
                hideLoading();
                showToast('Error processing work order', 'error');
                console.error('Work order processing error:', error);
            }
        }

        function getMachineForOperation(opName, section) {
            const op = opName.toString().trim().toLowerCase();
            const sectionStr = section.toString().trim().toUpperCase();
            
            //        (  P  F)
            const isSheetMetal = sectionStr.startsWith('P') || sectionStr.startsWith('F');
            
            if (isSheetMetal) {
                // : Shearing  Cropping      Shear
                if (op.includes('shear') || op.includes('shearing') || op.includes('cutting') || op.includes('crop')) {
                    return { machine: "Shear", type: 'shearing' };
                }
                if (op.includes('minimum') || op.includes('min')) {
                    return { machine: "83P", type: 'minimum' };
                }
                if (op.includes('bend') || op.includes('bending')) {
                    return { machine: "CNC Bending", type: 'bending' };
                }
                if (op.includes('finish') || op.includes('finishing') || op.includes('galv') || op.includes('galvanizing')) {
                    return { machine: "Finishing", type: 'finish' };
                }
            }
            
            //         
            const isAngle = sectionStr.startsWith('L');
            
            if (isAngle && (op.includes('min') || op === 'minimum')) {
                return { machine: "Machines: 206 / 20.20 / 10.10", type: 'primary' };
            }

            if (op.includes('crop') || op.includes('cut') || op.includes('cutting')) {
                return { machine: "Cutting Machine / Manual Plasma", type: 'cutting' };
            }

            if (op.includes('bend') || op.includes('bending')) {
                return { machine: "Press Machine", type: 'forming' };
            }

            if (op.includes('drill') || op.includes('drilling')) {
                return { machine: "Drilling Machine", type: 'drilling' };
            }

            if (op.includes('chamfer') || op.includes('chamfering') || op.includes('edge')) {
                return { machine: "Chamfering Machine", type: 'chamfering' };
            }

            if (op.includes('finish') || op.includes('finishing') || op.includes('galv') || op.includes('galvanizing')) {
                return { machine: "Finishing Area", type: 'finish' };
            }

            return { machine: "Standard Work Station", type: 'general' };
        }

        // ============= UI RENDERING FUNCTIONS =============
        function renderModelsList() {
            const container = document.getElementById('modelsContainer');
            const search = document.getElementById('searchInput').value.toLowerCase();
            container.innerHTML = '';

            const filteredDB = db.filter(entry => 
                entry.model.toLowerCase().includes(search) ||
                entry.type.toLowerCase().includes(search)
            );

            if (filteredDB.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 w-full py-10">No models.</p>';
                return;
            }

            filteredDB.forEach(entry => {
                const card = document.createElement('div');
                card.className = 'card cursor-pointer hover:shadow-lg transition';
                card.onclick = () => showDetails(entry.id);
                
                let iconClass = 'fa-tower-cell';
                let colorClass = 'text-blue-600';
                if(entry.type === 'Telecom') { iconClass = 'fa-wifi'; colorClass = 'text-purple-600'; }
                if(entry.type === '500KV') { colorClass = 'text-red-600'; }

                card.innerHTML = `
                    <div class="flex items-center gap-4 p-4">
                        <div class="bg-gray-100 p-3 rounded-full">
                            <i class="fa-solid ${iconClass} ${colorClass} text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800">${entry.model}</h4>
                            <div class="flex gap-2 mt-2">
                                <span class="badge badge-primary">${entry.type}</span>
                                <span class="text-xs text-gray-500">Items: ${entry.items.length}</span>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">${entry.date}</p>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-400"></i>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderWorkOrdersList() {
            const container = document.getElementById('workOrdersContainer');
            const search = document.getElementById('workOrderSearch').value.toLowerCase();
            container.innerHTML = '';

            const filtered = workOrdersDB.filter(wo => 
                wo.workOrderName.toLowerCase().includes(search) || 
                wo.projectName.toLowerCase().includes(search) ||
                wo.salesOrderNumber.toLowerCase().includes(search) ||
                wo.model.toLowerCase().includes(search) || 
                wo.type.toLowerCase().includes(search)
            );

            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-10">No work orders.</p>';
                return;
            }

            filtered.forEach(wo => {
                const card = document.createElement('div');
                card.className = 'card cursor-pointer hover:shadow-lg transition';
                card.onclick = () => showWorkOrderDetails(wo.id);
                
                const totalItems = wo.items.length;
                const completedItems = wo.items.filter(item => item.status === 'Completed').length;
                const progress = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
                
                card.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-bold text-gray-800">${wo.workOrderName}</h4>
                                <div class="flex gap-2 mt-2">
                                    <span class="badge badge-info">${wo.type}</span>
                                    <span class="badge badge-warning">${wo.model}</span>
                                    <span class="badge badge-success text-xs">${wo.date}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="block font-bold text-green-600">${completedItems}/${totalItems}</span>
                                <div class="progress w-24 mt-1">
                                    <div class="progress-bar" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <div class="flex justify-between items-center">
                                <div class="text-sm text-gray-600">
                                    <span class="mr-2"><i class="fa-solid fa-building mr-1"></i> ${wo.projectName}</span>
                                    <span class="block mt-1"><i class="fa-solid fa-tag mr-1"></i> ${wo.salesOrderNumber}</span>
                                </div>
                                <div class="text-xs text-gray-500">
                                    ${wo.creationTime}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderProductionList() {
            const container = document.getElementById('productionContainer');
            const search = document.getElementById('productionSearch').value.toLowerCase();
            container.innerHTML = '';

            const filtered = productionDB.filter(record => 
                record.workOrderName.toLowerCase().includes(search) || 
                record.projectName.toLowerCase().includes(search) ||
                record.machine.toLowerCase().includes(search) ||
                record.itemName.toLowerCase().includes(search) ||
                record.operator.toLowerCase().includes(search)
            );

            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-10">No production records.</p>';
                return;
            }

            filtered.forEach(record => {
                const card = document.createElement('div');
                card.className = 'card cursor-pointer hover:shadow-lg transition';
                card.onclick = () => showProductionDetails(record.id);
                
                const date = new Date(record.timestamp).toLocaleDateString();
                const time = new Date(record.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                card.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-bold text-gray-800">${record.itemName}</h4>
                                <div class="flex gap-2 mt-2">
                                    <span class="badge badge-info">${record.towerType}</span>
                                    <span class="badge badge-warning">${record.machine}</span>
                                    <span class="badge badge-success">${record.operation}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="block font-bold text-purple-600">${record.quantity} pieces</span>
                                <span class="block text-sm text-green-600">${record.producedWeight || '0'} kg</span>
                                <span class="text-xs text-gray-500">${record.shift}</span>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <div class="flex justify-between items-center">
                                <div class="text-sm text-gray-600">
                                    <span class="mr-2"><i class="fa-solid fa-file-contract mr-1"></i> ${record.workOrderName}</span>
                                    <span class="block mt-1"><i class="fa-solid fa-building mr-1"></i> ${record.projectName}</span>
                                </div>
                                <div class="text-xs text-gray-500">
                                    ${date} - ${time}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // ============= EVENT HANDLERS =============
        function onTowerTypeChange() {
            const towerType = document.getElementById('productionTowerType').value;
            if (towerType) {
                populateProductionModelDropdown();
                saveProductionPreferences();
            }
        }

        function onModelChange() {
            const model = document.getElementById('productionModel').value;
            if (model) {
                populateWorkOrderDropdown();
                saveProductionPreferences();
            }
        }

        function onWorkOrderChange() {
            const workOrderId = document.getElementById('productionWorkOrder').value;
            if (workOrderId) {
                populateProjectDropdown();
                saveProductionPreferences();
            }
        }

        function onMachineChange() {
            const machine = document.getElementById('productionMachine').value;
            if (machine) {
                updateOperatorsDropdown();
                loadAvailableItems();
                saveProductionPreferences();
            }
        }

        // ============= DROPDOWN POPULATION =============
        function populateTowerTypeDropdown() {
            const towerTypeSelect = document.getElementById('workOrderTowerType');
            towerTypeSelect.innerHTML = '<option value="" disabled selected>Select type...</option>';
            
            const towerTypes = [...new Set(db.map(item => item.type))];
            towerTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                towerTypeSelect.appendChild(option);
            });
            
            document.getElementById('workOrderModel').innerHTML = '<option value="" disabled selected>Select model...</option>';
        }

        function populateModelDropdown() {
            const towerType = document.getElementById('workOrderTowerType').value;
            const modelSelect = document.getElementById('workOrderModel');
            modelSelect.innerHTML = '<option value="" disabled selected>Select model...</option>';
            
            if (towerType) {
                const models = db.filter(item => item.type === towerType);
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.model;
                    option.textContent = model.model;
                    modelSelect.appendChild(option);
                });
            }
        }

        function populateProductionTowerTypeDropdown() {
            const towerTypeSelect = document.getElementById('productionTowerType');
            towerTypeSelect.innerHTML = '<option value="" disabled selected>Select type...</option>';
            
            const towerTypes = [...new Set(db.map(item => item.type))];
            towerTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                towerTypeSelect.appendChild(option);
            });
            
            document.getElementById('productionModel').innerHTML = '<option value="" disabled selected>Select model...</option>';
            document.getElementById('productionWorkOrder').innerHTML = '<option value="" disabled selected>Select work order...</option>';
            document.getElementById('productionProject').innerHTML = '<option value="" disabled selected>Will be filled automatically...</option>';
        }

        function populateProductionModelDropdown() {
            const towerType = document.getElementById('productionTowerType').value;
            const modelSelect = document.getElementById('productionModel');
            modelSelect.innerHTML = '<option value="" disabled selected>Select model...</option>';
            
            if (towerType) {
                const models = db.filter(item => item.type === towerType);
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.model;
                    option.textContent = model.model;
                    modelSelect.appendChild(option);
                });
            }
        }

        function populateWorkOrderDropdown() {
            const towerType = document.getElementById('productionTowerType').value;
            const model = document.getElementById('productionModel').value;
            const workOrderSelect = document.getElementById('productionWorkOrder');
            workOrderSelect.innerHTML = '<option value="" disabled selected>Select work order...</option>';
            
            if (towerType && model) {
                const workOrders = workOrdersDB.filter(wo => wo.type === towerType && wo.model === model);
                workOrders.forEach(wo => {
                    const option = document.createElement('option');
                    option.value = wo.id;
                    option.textContent = wo.workOrderName;
                    option.setAttribute('data-project', wo.projectName);
                    workOrderSelect.appendChild(option);
                });
            }
        }

        function populateProjectDropdown() {
            const workOrderId = document.getElementById('productionWorkOrder').value;
            const projectSelect = document.getElementById('productionProject');
            
            if (workOrderId) {
                const workOrder = workOrdersDB.find(wo => wo.id === parseInt(workOrderId));
                if (workOrder) {
                    projectSelect.innerHTML = `<option value="${workOrder.projectName}" selected>${workOrder.projectName}</option>`;
                    selectedWorkOrderItems = workOrder.items;
                }
            } else {
                projectSelect.innerHTML = '<option value="" disabled selected>Will be filled automatically...</option>';
            }
        }

        // ============= PRODUCTION RECORDING =============
        function recordProduction() {
            const towerType = document.getElementById('productionTowerType').value;
            const model = document.getElementById('productionModel').value;
            const workOrderId = document.getElementById('productionWorkOrder').value;
            const shift = document.getElementById('productionShift').value;
            const machine = document.getElementById('productionMachine').value;
            const operator = document.getElementById('productionOperatorSelect').value;
            const date = document.getElementById('productionDate').value;
            const quantity = parseInt(document.getElementById('productionQuantity').value);
            const notes = document.getElementById('productionNotes').value;
            const selectedItemIndex = document.getElementById('availableItemsSelect').value;
            
            // Validation
            if (!towerType || !model || !workOrderId || !shift || !machine || !date || !operator) {
                showToast('Please fill all required fields', 'warning');
                return;
            }

            if (!selectedItemIndex) {
                showToast('Please select item for processing', 'warning');
                return;
            }

            const workOrder = workOrdersDB.find(wo => wo.id === parseInt(workOrderId));
            if (!workOrder) {
                showToast('Work order not found', 'error');
                return;
            }

            const itemIndex = parseInt(selectedItemIndex);
            const item = workOrder.items[itemIndex];
            
            // Get operation name
            const selectedOption = document.getElementById('availableItemsSelect').selectedOptions[0];
            const operationName = selectedOption.getAttribute('data-operation');
            
            //       
            const isSheetMetal = item.section.toString().trim().toUpperCase().startsWith('P') || 
                                 item.section.toString().trim().toUpperCase().startsWith('F');
            
            //    Shear        Shearing  Cropping 
            if (isSheetMetal && machine === "Shear") {
                //    Shearing  Cropping  
                const shearingOperation = item.operations.find(op => 
                    op.name.toLowerCase().includes('shear') || 
                    op.name.toLowerCase().includes('cutting')
                );
                
                const croppingOperation = item.operations.find(op => 
                    op.name.toLowerCase().includes('crop')
                );
                
                //   Shearing
                if (shearingOperation) {
                    const shearingOpName = shearingOperation.name;
                    if (!item.completedOperations[shearingOpName]) {
                        item.completedOperations[shearingOpName] = {
                            completed: false,
                            completedQuantity: quantity,
                            totalRequired: item.quantity
                        };
                    } else {
                        item.completedOperations[shearingOpName].completedQuantity += quantity;
                        if (item.completedOperations[shearingOpName].completedQuantity >= item.quantity) {
                            item.completedOperations[shearingOpName].completed = true;
                        }
                    }
                }
                
                //   Cropping  (  )
                if (croppingOperation) {
                    const croppingOpName = croppingOperation.name;
                    if (!item.completedOperations[croppingOpName]) {
                        item.completedOperations[croppingOpName] = {
                            completed: false,
                            completedQuantity: quantity,
                            totalRequired: item.quantity
                        };
                    } else {
                        item.completedOperations[croppingOpName].completedQuantity += quantity;
                        if (item.completedOperations[croppingOpName].completedQuantity >= item.quantity) {
                            item.completedOperations[croppingOpName].completed = true;
                        }
                    }
                    
                    //   Cropping    
                    const croppingProductionRecord = {
                        id: Date.now() + 1,
                        workOrderId: parseInt(workOrderId),
                        workOrderName: workOrder.workOrderName,
                        projectName: workOrder.projectName,
                        towerType,
                        model,
                        shift,
                        machine: "Shear",
                        operator,
                        date,
                        itemName: item.itemName,
                        itemSection: item.section,
                        operation: croppingOperation.name,
                        quantity,
                        producedWeight: item.weightPerPiece * quantity,
                        weightPerPiece: item.weightPerPiece,
                        totalItemWeight: item.totalWeight,
                        notes: notes + " (Auto-completed with shearing)",
                        timestamp: Date.now()
                    };
                    
                    productionDB.push(croppingProductionRecord);
                }
            }
            
            //    (   )
            if (!isSheetMetal || machine !== "Shear") {
                // Get current completion status for this operation
                const operationCompletion = item.completedOperations[operationName];
                const alreadyCompleted = operationCompletion ? operationCompletion.completedQuantity : 0;
                const remainingForOperation = item.quantity - alreadyCompleted;
                
                if (quantity > remainingForOperation) {
                    showToast(`Required quantity (${quantity}) is greater than remaining for this operation (${remainingForOperation})`, 'warning');
                    return;
                }

                // Calculate weight produced
                const producedWeight = item.weightPerPiece * quantity;

                // Update item completion status for this operation
                if (!item.completedOperations[operationName]) {
                    item.completedOperations[operationName] = {
                        completed: false,
                        completedQuantity: quantity,
                        totalRequired: item.quantity
                    };
                } else {
                    item.completedOperations[operationName].completedQuantity += quantity;
                    
                    // Check if this operation is now complete
                    if (item.completedOperations[operationName].completedQuantity >= item.quantity) {
                        item.completedOperations[operationName].completed = true;
                    }
                }
            }
            
            // Find operation index
            const opIndex = item.operations.findIndex(op => op.name === operationName);
            const isLastOperation = opIndex === item.operations.length - 1;
            
            // Update total completed quantity for the item
            if (isLastOperation) {
                item.completedQuantity = (item.completedQuantity || 0) + quantity;
            }
            
            // Check if all operations are complete for this quantity
            let allOpsComplete = true;
            item.operations.forEach(op => {
                if (!item.completedOperations[op.name] || 
                    item.completedOperations[op.name].completedQuantity < item.quantity) {
                    allOpsComplete = false;
                }
            });
            
            // Update item status
            if (allOpsComplete && item.completedQuantity >= item.quantity) {
                item.status = 'Completed';
            } else {
                item.status = 'In Progress';
            }

            // Save updated work order
            const workOrderIndex = workOrdersDB.findIndex(wo => wo.id === parseInt(workOrderId));
            workOrdersDB[workOrderIndex] = workOrder;
            localStorage.setItem('workOrdersDB', JSON.stringify(workOrdersDB));

            // Create production record
            const productionRecord = {
                id: Date.now(),
                workOrderId: parseInt(workOrderId),
                workOrderName: workOrder.workOrderName,
                projectName: workOrder.projectName,
                towerType,
                model,
                shift,
                machine,
                operator,
                date,
                itemName: item.itemName,
                itemSection: item.section,
                operation: operationName,
                quantity,
                producedWeight: item.weightPerPiece * quantity,
                weightPerPiece: item.weightPerPiece,
                totalItemWeight: item.totalWeight,
                notes,
                timestamp: Date.now()
            };

            // Save production record
            productionDB.push(productionRecord);
            localStorage.setItem('productionDB', JSON.stringify(productionDB));

            // Save preferences
            saveProductionPreferences();
            
            // Reset form
            document.getElementById('availableItemsSelect').innerHTML = '<option value="" disabled selected>Select item...</option>';
            document.getElementById('itemDetails').classList.add('hidden');
            document.getElementById('quantityWarning').classList.add('hidden');
            document.getElementById('productionQuantity').value = 1;
            document.getElementById('productionNotes').value = '';
            
            // Reload available items
            setTimeout(() => {
                loadAvailableItems();
            }, 100);
            
            updateStats();
            updateDashboard();
            renderProductionList();
            renderWorkOrdersList();
            
            showToast('Production recorded successfully', 'success');
        }

        // ============= AVAILABLE ITEMS MANAGEMENT =============
        function loadAvailableItems() {
            const machine = document.getElementById('productionMachine').value;
            const workOrderId = document.getElementById('productionWorkOrder').value;
            
            if (!machine || !workOrderId) {
                showToast('Please select machine and work order first', 'warning');
                return;
            }

            const workOrder = workOrdersDB.find(wo => wo.id === parseInt(workOrderId));
            if (!workOrder) return;

            const availableItemsSelect = document.getElementById('availableItemsSelect');
            availableItemsSelect.innerHTML = '<option value="" disabled selected>Select item...</option>';
            
            currentAvailableItems = [];
            let hasItems = false;

            workOrder.items.forEach((item, itemIndex) => {
                // Check if item is already completed
                if (item.status === 'Completed') return;

                //       
                const isSheetMetal = item.section.toString().trim().toUpperCase().startsWith('P') || 
                                     item.section.toString().trim().toUpperCase().startsWith('F');
                
                // Find operations that this machine can do and are not yet completed
                item.operations.forEach((operation, opIndex) => {
                    // Check if machine can do this operation
                    const canDo = canMachineDoOperation(machine, operation.name, item.section);
                    
                    if (canDo) {
                        // Check if this operation is already completed
                        const operationCompletion = item.completedOperations[operation.name];
                        const alreadyCompleted = operationCompletion ? operationCompletion.completedQuantity : 0;
                        const remainingForOperation = item.quantity - alreadyCompleted;
                        
                        // Only show if there's remaining quantity for this operation
                        if (remainingForOperation > 0) {
                            // Check if previous operations are completed (if any)
                            let previousOpsCompleted = true;
                            for (let i = 0; i < opIndex; i++) {
                                const prevOp = item.operations[i];
                                const prevOpCompletion = item.completedOperations[prevOp.name];
                                if (!prevOpCompletion || prevOpCompletion.completedQuantity < item.quantity) {
                                    previousOpsCompleted = false;
                                    break;
                                }
                            }
                            
                            if (previousOpsCompleted) {
                                hasItems = true;
                                const option = document.createElement('option');
                                option.value = itemIndex;
                                
                                //    Shear   Shearing  Cropping  
                                let displayName = operation.name;
                                if (isSheetMetal && machine === 'Shear') {
                                    if (operation.name.toLowerCase().includes('crop')) {
                                        //   Cropping  
                                        return;
                                    }
                                    if (operation.name.toLowerCase().includes('shear') || operation.name.toLowerCase().includes('cutting')) {
                                        displayName = "Shearing & Cropping";
                                    }
                                }
                                
                                option.textContent = `${item.itemName} - ${item.section} - ${displayName} (Remaining: ${remainingForOperation})`;
                                option.setAttribute('data-operation', operation.name);
                                option.setAttribute('data-section', item.section);
                                option.setAttribute('data-total', item.quantity);
                                option.setAttribute('data-completed', alreadyCompleted);
                                option.setAttribute('data-remaining', remainingForOperation);
                                option.setAttribute('data-weight', item.weightPerPiece || 0);
                                availableItemsSelect.appendChild(option);
                                
                                currentAvailableItems.push({
                                    itemIndex: itemIndex,
                                    operationName: operation.name,
                                    item: item,
                                    remaining: remainingForOperation
                                });
                            }
                        }
                    }
                });
            });

            if (hasItems && currentAvailableItems.length > 0) {
                document.getElementById('availableItemsContainer').classList.remove('hidden');
                document.getElementById('remainingQuantityInfo').textContent = `Available items: ${currentAvailableItems.length}`;
            } else {
                document.getElementById('availableItemsContainer').classList.add('hidden');
                document.getElementById('itemDetails').classList.add('hidden');
                showToast('No items available for this machine', 'warning');
            }
        }

        function updateQuantityField() {
            const selectedOption = document.getElementById('availableItemsSelect').selectedOptions[0];
            
            if (selectedOption && selectedOption.value) {
                const remaining = parseInt(selectedOption.getAttribute('data-remaining'));
                const completed = parseInt(selectedOption.getAttribute('data-completed'));
                const total = parseInt(selectedOption.getAttribute('data-total'));
                const weight = parseFloat(selectedOption.getAttribute('data-weight'));
                
                document.getElementById('selectedItemSection').textContent = selectedOption.getAttribute('data-section');
                document.getElementById('selectedItemOperation').textContent = selectedOption.getAttribute('data-operation');
                document.getElementById('selectedItemTotal').textContent = total;
                document.getElementById('selectedItemCompleted').textContent = completed;
                document.getElementById('selectedItemRemaining').textContent = remaining;
                document.getElementById('selectedItemWeight').textContent = `${weight} kg/piece`;
                document.getElementById('itemDetails').classList.remove('hidden');
                
                document.getElementById('productionQuantity').value = 1;
                document.getElementById('productionQuantity').max = remaining;
                document.getElementById('productionQuantity').min = 1;
            } else {
                document.getElementById('itemDetails').classList.add('hidden');
            }
        }

        function validateQuantity() {
            const quantityInput = document.getElementById('productionQuantity');
            const selectedOption = document.getElementById('availableItemsSelect').selectedOptions[0];
            const warningDiv = document.getElementById('quantityWarning');
            
            if (!selectedOption || !selectedOption.value) {
                warningDiv.classList.add('hidden');
                return;
            }
            
            const remaining = parseInt(selectedOption.getAttribute('data-remaining'));
            const enteredQuantity = parseInt(quantityInput.value);
            
            if (enteredQuantity > remaining) {
                warningDiv.textContent = `Entered quantity (${enteredQuantity}) is greater than remaining (${remaining})`;
                warningDiv.classList.remove('hidden');
                quantityInput.value = remaining;
            } else if (enteredQuantity < 1) {
                warningDiv.textContent = "Quantity must be at least 1";
                warningDiv.classList.remove('hidden');
                quantityInput.value = 1;
            } else {
                warningDiv.classList.add('hidden');
            }
        }

        function canMachineDoOperation(machine, operationName, section) {
            const op = operationName.toString().trim().toLowerCase();
            const sectionStr = section.toString().trim().toUpperCase();
            
            //        (  P  F)
            const isSheetMetal = sectionStr.startsWith('P') || sectionStr.startsWith('F');
            
            if (isSheetMetal) {
                if (machine === 'Shear') {
                    // : Shear   Shearing  Cropping 
                    return op.includes('shear') || op.includes('shearing') || op.includes('cutting') || op.includes('crop');
                }
                if (machine === '83P') {
                    return op.includes('minimum') || op.includes('min');
                }
                if (machine === 'CNC Bending') {
                    return op.includes('bend') || op.includes('bending');
                }
                if (machine === 'Finishing') {
                    return op.includes('finish') || op.includes('finishing') || op.includes('galv') || op.includes('galvanizing');
                }
            }
            
            //         
            const isAngle = sectionStr.startsWith('L');
            
            if (machine === '206' || machine === '20.20' || machine === '10.10') {
                return isAngle && (op.includes('minimum') || op.includes('min'));
            }
            else if (machine === 'Cropping') {
                return op.includes('crop') || op.includes('cut') || op.includes('cutting');
            }
            else if (machine === 'Manual Plasma') {
                return op.includes('crop') || op.includes('cut') || op.includes('cutting') || op.includes('plasma');
            }
            else if (machine === 'Press') {
                return op.includes('bend') || op.includes('bending');
            }
            else if (machine === 'Drill') {
                return op.includes('drill') || op.includes('drilling');
            }
            else if (machine === 'Chamfering') {
                return op.includes('chamfer') || op.includes('chamfering') || op.includes('edge');
            }
            else if (machine === 'Finishing') {
                return op.includes('finish') || op.includes('finishing') || op.includes('galv') || op.includes('galvanizing');
            }
            
            return false;
        }

        // ============= DETAIL VIEWS =============
        function showDetails(id) {
            const entry = db.find(m => m.id === id);
            if (!entry) return;

            document.getElementById('viewTitle').textContent = entry.model;
            document.getElementById('viewType').textContent = entry.type;
            
            const tbody = document.getElementById('detailsTableBody');
            tbody.innerHTML = '';

            entry.items.forEach((item, index) => {
                const tr = document.createElement('tr');
                
                let operationsHTML = '';
                item.operations.forEach((op, i) => {
                    let color = 'bg-gray-100 text-gray-700';
                    if(op.type === 'primary' || op.type === 'minimum') color = 'bg-blue-100 text-blue-800';
                    if(op.type === 'finish') color = 'bg-green-100 text-green-800';
                    if(op.type === 'cutting' || op.type === 'shearing') color = 'bg-orange-100 text-orange-800';
                    if(op.type === 'forming' || op.type === 'bending') color = 'bg-purple-100 text-purple-800';
                    
                    operationsHTML += `
                        <div class="inline-flex items-center">
                            ${i > 0 ? '<i class="fa-solid fa-arrow-right text-gray-300 mx-1 text-xs"></i>' : ''}
                            <span class="px-2 py-1 text-xs rounded ${color}">
                                ${op.name}
                            </span>
                        </div>
                    `;
                });

                tr.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td class="font-bold">${item.itemName}</td>
                    <td>
                        <span class="px-2 py-1 text-xs rounded-full ${
                            item.section.startsWith('L') ? 'bg-indigo-100 text-indigo-800' : 
                            item.section.startsWith('P') || item.section.startsWith('F') ? 'bg-teal-100 text-teal-800' : 
                            'bg-pink-100 text-pink-800'
                        }">
                            ${item.section}
                        </span>
                    </td>
                    <td>${item.steelGrade || '-'}</td>
                    <td>${operationsHTML}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('detailsView').classList.remove('hidden');
            document.getElementById('detailsView').scrollIntoView({ behavior: 'smooth' });
        }

        function showWorkOrderDetails(id) {
            const wo = workOrdersDB.find(o => o.id === id);
            if (!wo) return;

            currentWorkOrder = wo;
            
            document.getElementById('workOrderTitle').textContent = wo.workOrderName;
            document.getElementById('workOrderType').textContent = wo.type;
            document.getElementById('workOrderDate').textContent = wo.date;
            document.getElementById('workOrderProject').textContent = wo.projectName;
            document.getElementById('workOrderSalesNumber').textContent = wo.salesOrderNumber;
            document.getElementById('workOrderCreationDate').textContent = `${wo.date} - ${wo.creationTime}`;
            document.getElementById('workOrderTotalItems').textContent = wo.items.length;
            
            const tbody = document.getElementById('workOrderDetailsTableBody');
            tbody.innerHTML = '';

            wo.items.forEach((item, index) => {
                const tr = document.createElement('tr');
                
                let operationsHTML = '';
                item.operations.forEach((op) => {
                    const opCompletion = item.completedOperations[op.name];
                    const isCompleted = opCompletion && opCompletion.completedQuantity >= item.quantity;
                    const completedQty = opCompletion ? opCompletion.completedQuantity : 0;
                    
                    let color = 'bg-gray-100 text-gray-700';
                    if(isCompleted) color = 'bg-green-100 text-green-800';
                    else if (completedQty > 0) color = 'bg-yellow-100 text-yellow-800';
                    
                    operationsHTML += `
                        <div class="flex items-center text-xs p-1 rounded ${color} mb-1">
                            <span class="font-semibold">${op.name}</span>
                            <span class="ml-1">(${completedQty}/${item.quantity})</span>
                            ${isCompleted ? '<i class="fa-solid fa-check text-green-600 ml-1"></i>' : ''}
                        </div>
                    `;
                });

                tr.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td class="font-bold">${item.itemName}</td>
                    <td>
                        <span class="px-2 py-1 text-xs rounded-full ${
                            item.section.startsWith('L') ? 'bg-indigo-100 text-indigo-800' : 
                            item.section.startsWith('P') || item.section.startsWith('F') ? 'bg-teal-100 text-teal-800' : 
                            'bg-pink-100 text-pink-800'
                        }">
                            ${item.section}
                        </span>
                    </td>
                    <td>${item.steelGrade || '-'}</td>
                    <td>${item.length || '-'}</td>
                    <td class="font-bold ${item.status === 'Completed' ? 'text-green-700' : 'text-yellow-700'}">
                        ${item.completedQuantity || 0}/${item.quantity}
                    </td>
                    <td class="font-bold">${item.weightPerPiece || '0'}</td>
                    <td class="font-bold">${item.totalWeight || '0'}</td>
                    <td>${operationsHTML}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('workOrderDetailsView').classList.remove('hidden');
            document.getElementById('workOrderDetailsView').scrollIntoView({ behavior: 'smooth' });
        }

        function showProductionDetails(id) {
            const record = productionDB.find(r => r.id === id);
            if (!record) return;

            currentProduction = record;
            
            document.getElementById('productionTitle').textContent = record.itemName;
            document.getElementById('productionType').textContent = record.towerType;
            document.getElementById('productionShiftBadge').textContent = record.shift;
            document.getElementById('productionDateBadge').textContent = record.date;
            document.getElementById('productionProjectDetail').textContent = record.projectName;
            document.getElementById('productionMachineDetail').textContent = record.machine;
            document.getElementById('productionOperatorDetail').textContent = record.operator || 'Not specified';
            document.getElementById('productionQuantityDetail').textContent = `${record.quantity} pieces`;
            document.getElementById('productionWeightDetail').textContent = `${record.producedWeight || '0'} kg`;
            
            const tbody = document.getElementById('productionDetailsTableBody');
            tbody.innerHTML = '';

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-center">1</td>
                <td class="font-bold">${record.itemName}</td>
                <td>
                    <span class="px-2 py-1 text-xs rounded-full ${
                        record.itemSection.startsWith('L') ? 'bg-indigo-100 text-indigo-800' : 
                        record.itemSection.startsWith('P') || record.itemSection.startsWith('F') ? 'bg-teal-100 text-teal-800' : 
                        'bg-pink-100 text-pink-800'
                    }">
                        ${record.itemSection}
                    </span>
                </td>
                <td>${record.operation}</td>
                <td>
                    <span class="badge badge-success font-bold">Completed</span>
                </td>
                <td class="font-bold text-purple-700">${record.quantity}</td>
                <td class="font-bold text-green-700">${record.producedWeight || '0'} kg</td>
            `;
            tbody.appendChild(tr);

            document.getElementById('productionDetailsView').classList.remove('hidden');
            document.getElementById('productionDetailsView').scrollIntoView({ behavior: 'smooth' });
        }

        function hideDetails() {
            document.getElementById('detailsView').classList.add('hidden');
        }

        function hideWorkOrderDetails() {
            document.getElementById('workOrderDetailsView').classList.add('hidden');
        }

        function hideProductionDetails() {
            document.getElementById('productionDetailsView').classList.add('hidden');
        }

        // ============= REPORTS =============
        function populateReportDropdowns() {
            const workOrderSelect = document.getElementById('reportWorkOrder');
            const detailWorkOrderSelect = document.getElementById('detailReportWorkOrder');
            
            workOrderSelect.innerHTML = '<option value="" disabled selected>Select work order...</option>';
            detailWorkOrderSelect.innerHTML = '<option value="" disabled selected>Select work order...</option>';
            
            workOrdersDB.forEach(wo => {
                const option = document.createElement('option');
                option.value = wo.id;
                option.textContent = `${wo.workOrderName} - ${wo.projectName}`;
                workOrderSelect.appendChild(option);
                
                const option2 = document.createElement('option');
                option2.value = wo.id;
                option2.textContent = `${wo.workOrderName} - ${wo.projectName}`;
                detailWorkOrderSelect.appendChild(option2);
            });
        }

        function populateDailyReportWorkOrders() {
            const select = document.getElementById('dailyReportWorkOrder');
            select.innerHTML = '<option value="">All Work Orders</option>';
            
            workOrdersDB.forEach(wo => {
                const option = document.createElement('option');
                option.value = wo.id;
                option.textContent = `${wo.workOrderName} - ${wo.projectName}`;
                select.appendChild(option);
            });
        }

        function populateItemsForReport() {
            const workOrderId = document.getElementById('detailReportWorkOrder').value;
            const itemSelect = document.getElementById('detailReportItem');
            const container = document.getElementById('itemSelectionContainer');
            
            if (!workOrderId) {
                container.classList.add('hidden');
                return;
            }
            
            const workOrder = workOrdersDB.find(wo => wo.id === parseInt(workOrderId));
            if (!workOrder) return;
            
            // Clear previous items
            itemSelect.innerHTML = '<option value="" disabled selected>Select item...</option>';
            
            // Populate dropdown with work order items
            workOrder.items.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${item.itemName} - ${item.section} (${item.status}) - Qty: ${item.completedQuantity || 0}/${item.quantity}`;
                itemSelect.appendChild(option);
            });
            
            container.classList.remove('hidden');
        }

        function generateItemsStatusReport() {
            const workOrderId = document.getElementById('reportWorkOrder').value;
            
            if (!workOrderId) {
                showToast('Please select work order', 'warning');
                return;
            }
            
            const workOrder = workOrdersDB.find(wo => wo.id === parseInt(workOrderId));
            if (!workOrder) return;
            
            document.getElementById('reportTitle').textContent = `Items Status Report - ${workOrder.workOrderName}`;
            
            const header = document.getElementById('reportTableHeader');
            const body = document.getElementById('reportTableBody');
            
            header.innerHTML = `
                <tr>
                    <th>#</th>
                    <th>Item Name</th>
                    <th>Section</th>
                    <th>Steel Grade</th>
                    <th>Quantity</th>
                    <th>Weight/Piece</th>
                    <th>Total Weight</th>
                    <th>Completed</th>
                    <th>Remaining</th>
                    <th>Current Phase</th>
                    <th>Last Phase Reached</th>
                    <th>Status</th>
                    <th>Progress</th>
                </tr>
            `;
            
            body.innerHTML = '';
            
            // Sort items: completed first, then by section descending
            const sortedItems = [...workOrder.items].sort((a, b) => {
                // First sort by status (completed first)
                if (a.status === 'Completed' && b.status !== 'Completed') return -1;
                if (a.status !== 'Completed' && b.status === 'Completed') return 1;
                
                // Then sort by section descending
                return b.section.localeCompare(a.section);
            });
            
            sortedItems.forEach((item, index) => {
                const completed = item.completedQuantity || 0;
                const remaining = item.quantity - completed;
                const progress = item.quantity > 0 ? Math.round((completed / item.quantity) * 100) : 0;
                
                // Determine current phase (last completed operation)
                let currentPhase = 'Not Started';
                let lastPhaseReached = 'Not Started';
                
                if (item.operations.length > 0) {
                    // Find last completed operation
                    let lastCompletedOp = null;
                    let lastOpIndex = -1;
                    
                    item.operations.forEach((op, opIndex) => {
                        const opCompletion = item.completedOperations[op.name];
                        if (opCompletion && opCompletion.completedQuantity >= item.quantity) {
                            lastCompletedOp = op.name;
                            lastOpIndex = opIndex;
                        }
                    });
                    
                    if (lastCompletedOp) {
                        currentPhase = lastCompletedOp;
                        // Check if there's a next operation
                        if (lastOpIndex < item.operations.length - 1) {
                            lastPhaseReached = item.operations[lastOpIndex + 1].name;
                        } else {
                            lastPhaseReached = 'All Operations Complete';
                        }
                    } else {
                        currentPhase = item.operations[0].name;
                        lastPhaseReached = item.operations[0].name;
                    }
                }
                
                const tr = document.createElement('tr');
                tr.className = item.status === 'Completed' ? 'completed-first' : '';
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="font-bold">${item.itemName}</td>
                    <td class="font-bold">${item.section}</td>
                    <td>${item.steelGrade || '-'}</td>
                    <td class="font-bold">${item.quantity}</td>
                    <td class="font-bold">${item.weightPerPiece || '0'}</td>
                    <td class="font-bold">${item.totalWeight || '0'}</td>
                    <td class="text-green-600 font-bold">${completed}</td>
                    <td class="${remaining > 0 ? 'text-red-600 font-bold' : 'text-gray-600'}">${remaining}</td>
                    <td>
                        <span class="current-phase">${currentPhase}</span>
                    </td>
                    <td>
                        <span class="text-sm ${lastPhaseReached === 'All Operations Complete' ? 'text-green-600' : 'text-blue-600'}">
                            ${lastPhaseReached}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${item.status === 'Completed' ? 'badge-success' : 'badge-warning'}">
                            ${item.status}
                        </span>
                    </td>
                    <td>
                        <div class="flex items-center gap-2">
                            <div class="progress w-20">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                            <span class="text-xs">${progress}%</span>
                        </div>
                    </td>
                `;
                body.appendChild(tr);
            });
            
            document.getElementById('reportResults').classList.remove('hidden');
            document.getElementById('reportResults').scrollIntoView({ behavior: 'smooth' });
            
            // Show scroll to top button
            document.getElementById('scrollToTop').classList.remove('hidden');
        }

        function generateDetailedItemReport() {
            const workOrderId = document.getElementById('detailReportWorkOrder').value;
            const itemIndex = document.getElementById('detailReportItem').value;
            
            if (!workOrderId || !itemIndex) {
                showToast('Please select work order and item', 'warning');
                return;
            }
            
            const workOrder = workOrdersDB.find(wo => wo.id === parseInt(workOrderId));
            if (!workOrder) return;
            
            const item = workOrder.items[parseInt(itemIndex)];
            if (!item) return;
            
            // Collect production records for this item
            const itemProductionRecords = productionDB.filter(record => 
                record.workOrderId === parseInt(workOrderId) && 
                record.itemName === item.itemName
            );
            
            document.getElementById('reportTitle').textContent = `Detailed Production Report - ${item.itemName}`;
            
            const header = document.getElementById('reportTableHeader');
            const body = document.getElementById('reportTableBody');
            
            header.innerHTML = `
                <tr>
                    <th>#</th>
                    <th>Operation</th>
                    <th>Machine</th>
                    <th>Operator</th>
                    <th>Quantity</th>
                    <th>Weight Produced</th>
                    <th>Operation Date</th>
                    <th>Shift</th>
                    <th>Status</th>
                </tr>
            `;
            
            body.innerHTML = '';
            
            item.operations.forEach((operation, index) => {
                const opCompletion = item.completedOperations[operation.name];
                const isCompleted = opCompletion && opCompletion.completedQuantity >= item.quantity;
                const completedQty = opCompletion ? opCompletion.completedQuantity : 0;
                const operationRecords = itemProductionRecords.filter(record => record.operation === operation.name);
                
                if (operationRecords.length > 0) {
                    operationRecords.forEach((record, recordIndex) => {
                        // Use the production record date (operation execution date)
                        const operationDate = record.date;
                        
                        const tr = document.createElement('tr');
                        tr.className = 'bg-green-50';
                        tr.innerHTML = `
                            <td>${index + 1}.${recordIndex + 1}</td>
                            <td class="font-bold">${operation.name}</td>
                            <td>${record.machine}</td>
                            <td>${record.operator || 'Not specified'}</td>
                            <td class="font-bold">${record.quantity}</td>
                            <td class="font-bold">${record.producedWeight || '0'} kg</td>
                            <td>${operationDate}</td>
                            <td>${record.shift}</td>
                            <td>
                                <span class="badge badge-success">Completed</span>
                            </td>
                        `;
                        body.appendChild(tr);
                    });
                } else {
                    const tr = document.createElement('tr');
                    tr.className = isCompleted ? 'bg-green-50' : 'bg-yellow-50';
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td class="font-bold">${operation.name}</td>
                        <td>${operation.machine}</td>
                        <td>-</td>
                        <td>${completedQty}</td>
                        <td>${completedQty * (item.weightPerPiece || 0)} kg</td>
                        <td>-</td>
                        <td>-</td>
                        <td>
                            <span class="badge ${isCompleted ? 'badge-success' : completedQty > 0 ? 'badge-warning' : 'badge-danger'}">
                                ${isCompleted ? 'Completed' : completedQty > 0 ? 'In Progress' : 'Pending'}
                            </span>
                        </td>
                    `;
                    body.appendChild(tr);
                }
            });
            
            const summaryTr = document.createElement('tr');
            summaryTr.className = 'bg-blue-50 font-bold';
            
            const completedQty = item.completedQuantity || 0;
            const remaining = item.quantity - completedQty;
            const progress = item.quantity > 0 ? Math.round((completedQty / item.quantity) * 100) : 0;
            const totalWeightProduced = itemProductionRecords.reduce((sum, record) => sum + (record.producedWeight || 0), 0);
            
            summaryTr.innerHTML = `
                <td colspan="3">Summary</td>
                <td>Total Qty: ${item.quantity}</td>
                <td>Total Wt: ${item.totalWeight || '0'}</td>
                <td class="text-green-600">C: ${completedQty}</td>
                <td class="text-red-600">R: ${remaining}</td>
                <td>Wt Produced: ${totalWeightProduced.toFixed(2)} kg</td>
                <td>
                    <span class="badge ${item.status === 'Completed' ? 'badge-success' : 'badge-warning'}">
                        ${item.status}
                    </span>
                </td>
            `;
            body.appendChild(summaryTr);
            
            document.getElementById('reportResults').classList.remove('hidden');
            document.getElementById('reportResults').scrollIntoView({ behavior: 'smooth' });
        }

        function generateDailyProductionReport() {
            const fromDate = document.getElementById('dailyReportFromDate').value;
            const toDate = document.getElementById('dailyReportToDate').value;
            const shift = document.getElementById('dailyReportShift').value;
            const phase = document.getElementById('dailyReportPhase').value;
            const machine = document.getElementById('dailyReportMachine').value;
            const workOrderId = document.getElementById('dailyReportWorkOrder').value;
            
            if (!fromDate || !toDate) {
                showToast('Please select date range', 'warning');
                return;
            }
            
            // Filter records by date range
            let filteredRecords = productionDB.filter(record => {
                const recordDate = new Date(record.date);
                const from = new Date(fromDate);
                const to = new Date(toDate);
                
                return recordDate >= from && recordDate <= to;
            });
            
            // Apply additional filters
            if (shift) {
                filteredRecords = filteredRecords.filter(record => record.shift === shift);
            }
            
            if (phase) {
                filteredRecords = filteredRecords.filter(record => {
                    const op = record.operation.toLowerCase();
                    if (phase === 'minimum') return op.includes('min');
                    if (phase === 'crop') return op.includes('crop');
                    if (phase === 'cut') return op.includes('cut');
                    if (phase === 'bend') return op.includes('bend');
                    if (phase === 'drill') return op.includes('drill');
                    if (phase === 'chamfer') return op.includes('chamfer');
                    if (phase === 'finish') return op.includes('finish');
                    if (phase === 'shear') return op.includes('shear');
                    return true;
                });
            }
            
            if (machine) {
                filteredRecords = filteredRecords.filter(record => record.machine === machine);
            }
            
            if (workOrderId) {
                filteredRecords = filteredRecords.filter(record => record.workOrderId === parseInt(workOrderId));
            }
            
            // Calculate weight totals
            const totalWeight = filteredRecords.reduce((sum, record) => {
                return sum + (record.producedWeight || 0);
            }, 0);
            
            // Aggregate results
            const summary = {
                totalQuantity: filteredRecords.reduce((sum, record) => sum + record.quantity, 0),
                totalWeight: totalWeight,
                totalItems: filteredRecords.length,
                uniqueItems: [...new Set(filteredRecords.map(r => r.itemName))].length,
                uniqueOperators: [...new Set(filteredRecords.map(r => r.operator))].length,
                machinesUsed: [...new Set(filteredRecords.map(r => r.machine))],
                workOrders: [...new Set(filteredRecords.map(r => r.workOrderName))]
            };
            
            // Display report
            document.getElementById('reportTitle').textContent = `Daily Production Report - ${fromDate} to ${toDate}`;
            
            const header = document.getElementById('reportTableHeader');
            const body = document.getElementById('reportTableBody');
            
            header.innerHTML = `
                <tr>
                    <th>#</th>
                    <th>Work Order</th>
                    <th>Item Name</th>
                    <th>Section</th>
                    <th>Operation</th>
                    <th>Machine</th>
                    <th>Operator</th>
                    <th>Quantity</th>
                    <th>Weight Produced</th>
                    <th>Shift</th>
                    <th>Date</th>
                </tr>
            `;
            
            body.innerHTML = '';
            
            // Add report data
            filteredRecords.forEach((record, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="font-bold">${record.workOrderName}</td>
                    <td class="font-bold">${record.itemName}</td>
                    <td>${record.itemSection}</td>
                    <td>
                        <span class="badge badge-info">${record.operation}</span>
                    </td>
                    <td>${record.machine}</td>
                    <td>${record.operator || 'N/A'}</td>
                    <td class="font-bold text-purple-600">${record.quantity}</td>
                    <td class="font-bold text-green-600">${record.producedWeight || '0'} kg</td>
                    <td>${record.shift}</td>
                    <td>${record.date}</td>
                `;
                body.appendChild(tr);
            });
            
            // Add summary at the end
            const summaryTr = document.createElement('tr');
            summaryTr.className = 'bg-blue-50 font-bold';
            summaryTr.innerHTML = `
                <td colspan="7" class="text-right">Summary:</td>
                <td class="text-purple-600">Total Qty: ${summary.totalQuantity}</td>
                <td class="text-green-600">Total Wt: ${summary.totalWeight.toFixed(2)} kg</td>
                <td>Records: ${summary.totalItems}</td>
                <td>Items: ${summary.uniqueItems}</td>
            `;
            body.appendChild(summaryTr);
            
            document.getElementById('reportResults').classList.remove('hidden');
            document.getElementById('reportResults').scrollIntoView({ behavior: 'smooth' });
            
            // Update export button for daily report
            const exportBtn = document.querySelector('button[onclick="exportReportToExcel()"]');
            if (exportBtn) {
                exportBtn.setAttribute('onclick', 'exportDailyProductionReport()');
                exportBtn.innerHTML = '<i class="fa-solid fa-file-excel"></i> Export Daily Report';
            }
        }

        function generateWorkOrderStatusReport() {
            if (!currentWorkOrder) return;
            
            document.getElementById('reportWorkOrder').value = currentWorkOrder.id;
            switchTab('reports');
            
            setTimeout(() => {
                generateItemsStatusReport();
            }, 300);
        }

        function hideReportResults() {
            document.getElementById('reportResults').classList.add('hidden');
            document.getElementById('scrollToTop').classList.add('hidden');
        }

        function printReport() {
            window.print();
        }

        // ============= EXPORT FUNCTIONS =============
        function exportWorkOrderToExcel() {
            if (!currentWorkOrder) return;

            const exportData = [];
            
            exportData.push(['Work Order Information']);
            exportData.push(['Work Order Name:', currentWorkOrder.workOrderName]);
            exportData.push(['Project Name:', currentWorkOrder.projectName]);
            exportData.push(['Sales Order Number:', currentWorkOrder.salesOrderNumber]);
            exportData.push(['Tower Type:', currentWorkOrder.type]);
            exportData.push(['Model:', currentWorkOrder.model]);
            exportData.push(['Creation Date:', currentWorkOrder.date]);
            exportData.push(['']);
            
            exportData.push([
                '#', 'Item Name', 'Section', 'Steel Grade', 'Length', 'Quantity', 'Weight/Piece', 'Total Weight', 'Completed', 'Remaining', 'Status'
            ]);
            
            currentWorkOrder.items.forEach((item, index) => {
                exportData.push([
                    index + 1,
                    item.itemName,
                    item.section,
                    item.steelGrade || '-',
                    item.length || '-',
                    item.quantity,
                    item.weightPerPiece || '0',
                    item.totalWeight || '0',
                    item.completedQuantity || 0,
                    item.quantity - (item.completedQuantity || 0),
                    item.status || 'In Progress'
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Work Order");
            
            const fileName = `${currentWorkOrder.workOrderName}_${currentWorkOrder.date.replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast('Work order exported to Excel', 'success');
        }

        function exportProductionToExcel() {
            if (!currentProduction) return;

            const exportData = [];
            
            exportData.push(['Production Record Information']);
            exportData.push(['Item:', currentProduction.itemName]);
            exportData.push(['Project:', currentProduction.projectName]);
            exportData.push(['Work Order:', currentProduction.workOrderName]);
            exportData.push(['Machine:', currentProduction.machine]);
            exportData.push(['Operation:', currentProduction.operation]);
            exportData.push(['Operator:', currentProduction.operator]);
            exportData.push(['Quantity:', currentProduction.quantity]);
            exportData.push(['Weight Produced:', currentProduction.producedWeight || '0']);
            exportData.push(['Weight/Piece:', currentProduction.weightPerPiece || '0']);
            exportData.push(['Total Item Weight:', currentProduction.totalItemWeight || '0']);
            exportData.push(['Shift:', currentProduction.shift]);
            exportData.push(['Date:', currentProduction.date]);
            
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Production Record");
            
            const fileName = `Production_${currentProduction.itemName}_${currentProduction.date.replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast('Production record exported to Excel', 'success');
        }

        function exportReportToExcel() {
            const title = document.getElementById('reportTitle').textContent;
            const headers = Array.from(document.querySelectorAll('#reportTableHeader th')).map(th => th.textContent);
            const rows = Array.from(document.querySelectorAll('#reportTableBody tr')).map(tr => 
                Array.from(tr.querySelectorAll('td')).map(td => td.textContent)
            );

            const exportData = [title, '', headers, ...rows];
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            
            const fileName = `Report_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast('Report exported to Excel', 'success');
        }

        function exportDailyProductionReport() {
            const title = document.getElementById('reportTitle').textContent;
            const headers = Array.from(document.querySelectorAll('#reportTableHeader th')).map(th => th.textContent);
            const rows = Array.from(document.querySelectorAll('#reportTableBody tr')).map(tr => 
                Array.from(tr.querySelectorAll('td')).map(td => td.textContent)
            );

            const exportData = [
                [title],
                [''],
                ['Report Generated:', new Date().toLocaleString()],
                [''],
                headers,
                ...rows
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Daily Production");
            
            const fileName = `Daily_Production_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast('Daily production report exported to Excel', 'success');
        }

        // ============= HELPER FUNCTIONS =============
        function refreshDashboard() {
            updateDashboard();
            showToast('Dashboard refreshed', 'success');
        }

        function clearProductionForm() {
            if (confirm('Clear all fields?')) {
                document.getElementById('productionForm').reset();
                document.getElementById('productionDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('productionProject').innerHTML = '<option value="" disabled selected>Will be filled automatically...</option>';
                document.getElementById('productionOperatorSelect').innerHTML = '<option value="" disabled selected>Select operator...</option>';
                document.getElementById('availableItemsContainer').classList.add('hidden');
                document.getElementById('availableItemsSelect').innerHTML = '<option value="" disabled selected>Select item...</option>';
                document.getElementById('itemDetails').classList.add('hidden');
                
                productionPreferences = {
                    towerType: '',
                    model: '',
                    workOrderId: '',
                    shift: '',
                    machine: '',
                    operator: '',
                    date: new Date().toISOString().split('T')[0]
                };
                localStorage.setItem('productionPreferences', JSON.stringify(productionPreferences));
                
                populateProductionTowerTypeDropdown();
                
                showToast('Fields cleared', 'success');
            }
        }

        // Initialize the app
        window.onload = initializeApp;
    </script>
</body>
</html>